<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LXA ‚Äî CEO Dashboard</title>
  <meta name="description" content="Dashboard de ventas LXA con login Microsoft, lectura segura desde SharePoint (solo lectura)."/>

  <!-- Librer√≠as (mismo set que usabas) -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- MSAL: CDN oficial de Microsoft (evita bloqueos de jsDelivr) -->
  <script defer src="https://alcdn.msauth.net/browser/2.39.0/js/msal-browser.min.js"></script>

  <style>
    :root{--primary:#5e72e4;--accent:#10b981;--bg:#f3f4f6;--card:#fff;--muted:#6b7280}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#111}
    .container{max-width:1600px;margin:0 auto;padding:24px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:24px;margin-bottom:16px}
    .header{display:flex;justify-content:space-between;gap:16px;align-items:center}
    .btn{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:10px 18px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#111}.btn.small{padding:8px 12px;font-size:.9rem}
    .stack{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .filters select{padding:10px 14px;border:2px solid #e5e7eb;border-radius:10px}
    .tabs{display:flex;gap:8px;overflow:auto}
    .tab{padding:10px 16px;border-radius:10px;font-weight:600;cursor:pointer;white-space:nowrap}
    .tab.active{background:var(--primary);color:#fff}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid.cols-2{grid-template-columns:1fr 1fr}.grid.cols-3{grid-template-columns:repeat(3,1fr)}.grid.cols-4{grid-template-columns:repeat(4,1fr)}}
    .kpi{padding:18px;border-radius:14px;background:#fff;box-shadow:0 5px 18px rgba(0,0,0,.06)}
    .kpi h4{font-size:.85rem;color:var(--muted);text-transform:uppercase;margin-bottom:6px}
    .kpi .v{font-size:1.8rem;font-weight:800}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;font-size:.8rem}
    .VIP{background:#ddd6fe;color:#5b21b6}.Leal{background:#dcfce7;color:#166534}.Ocasional{background:#fef3c7;color:#92400e}.Riesgo{background:#fee2e2;color:#991b1b}
    .muted{color:var(--muted)}.hidden{display:none}
    table{width:100%;border-collapse:collapse}th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left}th{background:#f9fafb}
    .warn{background:#fffbeb;border-left:4px solid #f59e0b;padding:14px;border-radius:12px}
    .error{background:#fef2f2;border-left:4px solid #ef4444;padding:14px;border-radius:12px}
    .projection{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:16px}
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN -->
    <div id="loginCard" class="card" style="max-width:540px;margin:10vh auto;text-align:center">
      <h1>üîê LXA ‚Äî CEO Dashboard</h1>
      <p class="muted" style="margin:10px 0 18px">Inicia sesi√≥n con tu cuenta Microsoft para ver el dashboard</p>
      <button class="btn" id="btnLogin">Iniciar sesi√≥n con Microsoft</button>
      <div class="note" style="margin-top:12px">Permisos solicitados: <b>Files.Read</b> y <b>User.Read</b> (solo lectura)</div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
      <div class="card header">
        <div>
          <h2>üìä LXA ‚Äî CEO Dashboard</h2>
          <div id="userInfo" class="muted"></div>
          <div id="lastUpdate" class="muted"></div>
        </div>
        <div class="stack">
          <button class="btn small" id="btnRefresh">üîÑ Actualizar</button>
          <button class="btn secondary small" id="btnLogout">Cerrar sesi√≥n</button>
        </div>
      </div>

      <!-- FILTROS -->
      <div class="card filters stack">
        <div class="stack">
          <label><strong>A√±o:</strong></label>
          <select id="yearFilter"><option value="all">Todos</option></select>
          <label><strong>Mes:</strong></label>
          <select id="monthFilter">
            <option value="all">Todos</option>
            <option value="1">Enero</option><option value="2">Febrero</option><option value="3">Marzo</option><option value="4">Abril</option>
            <option value="5">Mayo</option><option value="6">Junio</option><option value="7">Julio</option><option value="8">Agosto</option>
            <option value="9">Septiembre</option><option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
          </select>
        </div>
        <div class="stack">
          <label><strong>Incluir ventas sin folio (#):</strong></label>
          <select id="includeNoFolio"><option value="no" selected>No</option><option value="si">S√≠</option></select>
        </div>
      </div>

      <!-- TABS -->
      <div class="card tabs">
        <div class="tab active" data-tab="score">üéØ Scorecard</div>
        <div class="tab" data-tab="ventas">üìà Ventas</div>
        <div class="tab" data-tab="clientes">üë• Clientes</div>
        <div class="tab" data-tab="productos">üì¶ Productos</div>
      </div>

      <div id="tab-score" class="tab-pane card"></div>
      <div id="tab-ventas" class="tab-pane hidden card"></div>
      <div id="tab-clientes" class="tab-pane hidden card"></div>
      <div id="tab-productos" class="tab-pane hidden card"></div>
    </div>
  </div>

  <script>
  // ========================
  // 1) CONFIG
  // ========================
  const CONFIG = {
    // Excel de ventas (LXA)
    shareUrl: 'https://laidealmx-my.sharepoint.com/:x:/g/personal/carlosc_laideal_com_mx/EY8QlfTcVY9Kq3TQk3XcDusB6QsET2u1DfBFDnclSLBhXw?e=PfD0RP',
    sheetName: 'LXA',
    metaCrecimiento2025: 0.15,
    diasClienteInactivo: 60,
    topClientes: 10,
    // Columnas tolerantes
    columns: {
      fecha: ['Salida','Fecha','Date'],
      folio: ['#','Folio','Factura','DocNum'],
      cliente: ['Cliente','Customer','Nombre cliente'],
      producto: ['Producto(s)','Producto','Descripci√≥n','Item'],
      cantidad: ['Cantidad','Qty','Unidades'],
      subtotal: ['Subtotal 2','Subtotal','Sub total'],
      total: ['Total','Importe total','Venta total'],
      vendedor: ['Vendedor','Seller','Salesperson'],
      estado: ['Estado','Status'],
      codigo: ['Codigo','C√≥digo','SKU','Clave']
    },
    // Excel de costos
    costs: {
      shareUrl: 'https://laidealmx-my.sharepoint.com/:x:/g/personal/jcarredano_laideal_com_mx/Ee5DS7L1BJJJr-uW19raWisB_07jKSnXsvIUD5Z8Ezy25w?e=QZ9s1s',
      priceSheet: 'Precios de Lista 2025',
      codesSheet: 'CODIGOS',
      columns: {
        price_product: ['Producto','Descripci√≥n','Nombre','Producto(s)'],
        price_code: ['Codigo','C√≥digo','SKU','Clave'],
        price_cost: ['COSTO DINAMICO ALMEXA','Costo din√°mico Almexa','Costo Almexa'],
        code_code: ['Codigo','C√≥digo','SKU','Clave'],
        code_product: ['Producto','Descripci√≥n','Nombre','Producto(s)']
      }
    }
  }
  // Usaremos Subtotal (sin IVA) como monto de referencia
  const AMOUNT_FIELD = 'subtotal'

  // ========================
  // 2) MSAL (Auth)
  // ========================
  const msalConfig = {
    auth:{
      clientId:'9d480cdb-912b-4132-9882-f36d6c3b12e5',
      authority:'https://login.microsoftonline.com/45f5b6e6-42e0-4fdd-b61a-df489f75dc8c',
      redirectUri:'https://jcarredanot.github.io/dashboard-lxa/'
    },
    cache:{ cacheLocation:'localStorage', storeAuthStateInCookie:false }
  }
  const GRAPH_SCOPES = ['User.Read','Files.Read']
  let msalInstance;

  // ========================
  // 3) Estado
  // ========================
  let allData = [], filtered = [], analytics = {}
  const charts = {}
  let costMap = new Map() // codigo -> { costo }

  // ========================
  // 4) Utils
  // ========================
  const $ = sel => document.querySelector(sel)
  const byId = id => document.getElementById(id)
  const fmtCurrency = v => '$' + (v||0).toLocaleString('es-MX',{minimumFractionDigits:2,maximumFractionDigits:2})

  function findCol(row, candidates){
    for (const name of candidates){ if (row.hasOwnProperty(name)) return row[name] }
    const keys = Object.keys(row)
    for (const name of candidates){
      const k = keys.find(x => x && x.toString().trim().toLowerCase() === name.toLowerCase())
      if (k) return row[k]
    }
    return undefined
  }
  function parseExcelDate(value){
    if (value == null) return null
    if (typeof value === 'number'){ const epoch = new Date(Date.UTC(1899,11,30)); return new Date(epoch.getTime() + value*86400000) }
    if (typeof value === 'string'){ const m=value.trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); if(m) return new Date(+m[3],+m[2]-1,+m[1]); const d=new Date(value); if(!isNaN(d)) return d }
    if (value instanceof Date) return value
    return null
  }
  function pickSheet(workbook, desired){
    const exact = workbook.SheetNames.find(n => n.trim()===desired)
    if (exact) return workbook.Sheets[exact]
    const loose = workbook.SheetNames.find(n => n.trim().toLowerCase()===desired.trim().toLowerCase())
    return workbook.Sheets[loose||workbook.SheetNames[0]]
  }

  // ========================
  // 5) Auth Flow
  // ========================
  function initMsal(){
    if (typeof msal === 'undefined'){
      alert('MSAL no carg√≥. Verifica acceso a https://alcdn.msauth.net')
      return
    }
    msalInstance = new msal.PublicClientApplication(msalConfig)
    msalInstance.handleRedirectPromise().then(r=>{ if(r?.account) afterLogin(r.account) }).catch(e=>console.error('MSAL redirect',e))
  }
  async function login(){
    if(!msalInstance) initMsal()
    const resp = await msalInstance.loginPopup({ scopes: GRAPH_SCOPES })
    afterLogin(resp.account)
  }
  function logout(){ if(msalInstance) msalInstance.logoutPopup() }
  function afterLogin(account){
    byId('loginCard').classList.add('hidden')
    byId('app').classList.remove('hidden')
    byId('userInfo').textContent = 'Usuario: '+(account?.name||'')
    loadData()
  }
  async function getToken(){
    const [acct] = msalInstance.getAllAccounts(); if(!acct) throw new Error('No hay sesi√≥n activa')
    const r = await msalInstance.acquireTokenSilent({ scopes: GRAPH_SCOPES, account: acct })
    return r.accessToken
  }

  // ========================
  // 6) Carga de datos (Graph)
  // ========================
  async function loadData(){
    try{
      byId('lastUpdate').textContent = 'Cargando‚Ä¶'
      const token = await getToken()
      await maybeLoadCosts(token) // primero costos

      // LXA
      const encoded = 'u!' + btoa(CONFIG.shareUrl).replace(/=+/g,'').replace(/\//g,'_').replace(/\+/g,'-')
      const metaRes = await fetch(`https://graph.microsoft.com/v1.0/shares/${encoded}/driveItem`, { headers:{ Authorization:`Bearer ${token}` } })
      if(!metaRes.ok) throw new Error('No se pudo obtener metadata LXA ('+metaRes.status+')')
      const meta = await metaRes.json()

      const dl = await fetch(`https://graph.microsoft.com/v1.0/drives/${meta.parentReference.driveId}/items/${meta.id}/content`, {
        headers:{ Authorization:`Bearer ${token}` }
      })
      if(!dl.ok) throw new Error('No se pudo descargar LXA ('+dl.status+')')
      const buf = await dl.arrayBuffer()
      const wb = XLSX.read(buf, { type:'array' })
      const ws = pickSheet(wb, CONFIG.sheetName)
      const rows = XLSX.utils.sheet_to_json(ws, { defval: null })

      // Parseo
      const out = []
      for (const row of rows){
        const fecha = parseExcelDate( findCol(row, CONFIG.columns.fecha) ); if(!fecha) continue
        const total = parseFloat(String(findCol(row, CONFIG.columns.total)||'').replace(/[$,()]/g,''))||0
        const subtotal = parseFloat(String(findCol(row, CONFIG.columns.subtotal)||'').replace(/[$,()]/g,''))||0
        const cantidad = parseInt(findCol(row, CONFIG.columns.cantidad))||0
        const folio = findCol(row, CONFIG.columns.folio) || ''
        const cliente = (findCol(row, CONFIG.columns.cliente)||'').toString().trim()
        const producto = (findCol(row, CONFIG.columns.producto)||'').toString().trim()
        const vendedor = (findCol(row, CONFIG.columns.vendedor)||'').toString().trim()
        const estado = (findCol(row, CONFIG.columns.estado)||'').toString().trim()
        const codigo = (findCol(row, CONFIG.columns.codigo)||'').toString().trim()

        const monto = (AMOUNT_FIELD==='subtotal'? subtotal: total)
        const precioUnit = cantidad>0 ? (monto/cantidad) : 0
        const costEntry = costMap.get(codigo) || null
        const costoUnit = costEntry?.costo ?? null
        const utilidad = (costoUnit!=null) ? (precioUnit - costoUnit) * (cantidad||0) : null
        const margen_pct = (costoUnit!=null && precioUnit>0) ? ((precioUnit - costoUnit)/precioUnit)*100 : null

        out.push({fecha, a√±o:fecha.getFullYear(), mes:fecha.getMonth()+1, numFactura:folio, cliente, producto, cantidad, subtotal, total, vendedor, estado, codigo, precioUnit, costoUnit, utilidad, margen_pct})
      }

      allData = out
      updateFilters()
      computeAnalytics()
      renderAll()
      byId('lastUpdate').textContent = '√öltima actualizaci√≥n: '+ new Date().toLocaleString('es-MX')
    }catch(e){
      byId('tab-score').innerHTML = `<div class="error"><h3>‚ö†Ô∏è Error al cargar datos</h3><p>${e.message}</p><ul><li>Revisa la URL compartida de SharePoint</li><li>Confirma permisos Files.Read</li><li>Valida el nombre de la hoja: <b>${CONFIG.sheetName}</b></li></ul></div>`
    }
  }

  // Cargar costos
  async function maybeLoadCosts(token){
    try{
      const c = CONFIG.costs; if(!c?.shareUrl){ costMap = new Map(); return }
      const encoded = 'u!' + btoa(c.shareUrl).replace(/=+/g,'').replace(/\//g,'_').replace(/\+/g,'-')
      const metaRes = await fetch(`https://graph.microsoft.com/v1.0/shares/${encoded}/driveItem`, { headers:{ Authorization:`Bearer ${token}` } })
      if(!metaRes.ok) throw new Error('No se pudo obtener metadata de COSTOS ('+metaRes.status+')')
      const meta = await metaRes.json()
      const dl = await fetch(`https://graph.microsoft.com/v1.0/drives/${meta.parentReference.driveId}/items/${meta.id}/content`, { headers:{ Authorization:`Bearer ${token}` } })
      if(!dl.ok) throw new Error('No se pudo descargar COSTOS ('+dl.status+')')
      const buf = await dl.arrayBuffer()
      const wb = XLSX.read(buf, { type:'array' })

      // Mapear nombre->c√≥digo desde hoja CODIGOS
      const wsCodes = pickSheet(wb, c.codesSheet)
      const rowsCodes = XLSX.utils.sheet_to_json(wsCodes, { defval: null })
      const nameToCode = new Map()
      for (const r of rowsCodes){
        const code = (findCol(r, c.columns.code_code)||'').toString().trim()
        const pname = (findCol(r, c.columns.code_product)||'').toString().trim()
        if (code && pname) nameToCode.set(pname.toUpperCase(), code)
      }

      // Precios
      const wsPrice = pickSheet(wb, c.priceSheet)
      const rowsPrice = XLSX.utils.sheet_to_json(wsPrice, { defval: null })
      const m = new Map()
      for (const r of rowsPrice){
        const codeDirect = (findCol(r, c.columns.price_code)||'').toString().trim()
        const pname = (findCol(r, c.columns.price_product)||'').toString().trim()
        const costRaw = findCol(r, c.columns.price_cost)
        const costo = parseFloat(String(costRaw||'').replace(/[$,()]/g,'')); if (isNaN(costo)) continue
        let key = codeDirect
        if (!key && pname){ key = nameToCode.get(pname.toUpperCase()) || '' }
        if (!key) continue
        m.set(key, { costo })
      }
      costMap = m
    }catch(e){ console.warn('COSTOS no cargado:', e.message); costMap = new Map() }
  }

  // ========================
  // 7) Filtros y analytics
  // ========================
  function updateFilters(){
    const years = [...new Set(allData.map(r=>r.a√±o))].sort()
    byId('yearFilter').innerHTML = '<option value="all">Todos</option>' + years.map(y=>`<option value="${y}">${y}</option>`).join('')
    filtered = allData.slice()
  }
  function applyFilters(){
    const y = byId('yearFilter').value
    const m = byId('monthFilter').value
    const inc = byId('includeNoFolio').value === 'si'
    filtered = allData.filter(r=>{
      if (y !== 'all' && r.a√±o !== +y) return false
      if (m !== 'all' && r.mes !== +m) return false
      if (!inc && !r.numFactura) return false
      return true
    })
    computeAnalytics()
    renderAll()
  }
  function computeAnalytics(){
    const withFolio = filtered
    const totalVentas = withFolio.reduce((a,r)=> a + (r[AMOUNT_FIELD]||0), 0)
    const numFact = withFolio.length
    const ticket = numFact ? totalVentas/numFact : 0

    const ventasPorA√±o = {}
    for (const r of allData){ ventasPorA√±o[r.a√±o]=(ventasPorA√±o[r.a√±o]||0)+(r[AMOUNT_FIELD]||0) }
    const v24 = ventasPorA√±o[2024]||0, v25 = ventasPorA√±o[2025]||0
    const meta2025 = v24 * (1 + CONFIG.metaCrecimiento2025)
    const avance = meta2025 ? (v25/meta2025)*100 : 0
    const crec = v24 ? ((v25 - v24)/v24)*100 : 0

    // Clientes
    const cMap = new Map()
    for (const r of filtered){
      if (!r.cliente) continue
      const cur = cMap.get(r.cliente) || { total:0, facturas:0, ultima:r.fecha }
      cur.total += (r[AMOUNT_FIELD]||0)
      cur.facturas += 1
      if (r.fecha > cur.ultima) cur.ultima = r.fecha
      cMap.set(r.cliente, cur)
    }
    const clientes = [...cMap.entries()].map(([nombre,st])=>{
      const dias = Math.floor((Date.now() - st.ultima)/86400000)
      let seg = 'Ocasional'
      if (dias <= 30 && st.facturas >= 5) seg = 'VIP'
      else if (dias <= 60 && st.facturas >= 3) seg = 'Leal'
      else if (dias > 90) seg = 'Riesgo'
      return { nombre, total: st.total, facturas: st.facturas, ultima: st.ultima, dias, segmento: seg }
    }).sort((a,b)=>b.total-a.total)
    const inactivos = clientes.filter(c=>c.dias > CONFIG.diasClienteInactivo)

    // Productos (ABC por subtotal)
    const pMap = new Map(); let totalSub = 0
    for (const r of filtered){
      if (!r.producto) continue
      const cur = pMap.get(r.producto) || { cantidad:0, valor:0 }
      cur.cantidad += (r.cantidad||0); cur.valor += (r.subtotal||0)
      pMap.set(r.producto, cur); totalSub += (r.subtotal||0)
    }
    const productos = [...pMap.entries()].map(([nombre,st])=>({ nombre, cantidad:st.cantidad, valor:st.valor }))
                             .sort((a,b)=>b.valor-a.valor)
    let acc=0; for (const p of productos){ acc += p.valor; const pct = totalSub? (acc/totalSub)*100 : 0; p.categoria = pct<=80?'A': pct<=95?'B':'C' }

    // Proyecci√≥n
    const now = new Date(); const MA=now.getMonth()+1, YA=now.getFullYear(), dia=now.getDate()
    const diasMes = new Date(YA, MA, 0).getDate()
    const ventasMes = allData.filter(r=>r.a√±o===YA && r.mes===MA).reduce((a,r)=>a+(r[AMOUNT_FIELD]||0),0)
    const prom = dia? ventasMes/dia : 0
    const proj = prom * diasMes
    const metaMensual = meta2025/12
    const diasRest = Math.max(0, diasMes - dia)
    const vNeces = diasRest? Math.max(0,(metaMensual - ventasMes)/diasRest) : 0

    // Rentabilidad global
    const utilidadTotal = filtered.reduce((a,r)=> a + (r.utilidad||0), 0)
    const margenPonderado = totalVentas>0 ? (utilidadTotal/totalVentas)*100 : null

    analytics = {
      totalVentas, numFacturas:numFact, ticketPromedio:ticket,
      ventasPorA√±o, ventas2024:v24, ventas2025:v25, meta2025, avanceVsMeta:avance, crecimientoAnual:crec,
      clientes, totalClientes:clientes.length, clientesInactivos:inactivos,
      productos,
      proyeccion:{ ventasMes, proyeccion:proj, metaMensual, diasRestantes:diasRest, ventasNecesarias:vNeces, probabilidad: metaMensual? (proj/metaMensual)*100 : 0 },
      utilidadTotal, margenPonderado
    }
  }

  // ========================
  // 8) Render
  // ========================
  function switchTab(key){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'))
    document.querySelector(`.tab[data-tab="${key}"]`).classList.add('active')
    document.querySelectorAll('.tab-pane').forEach(p=>p.classList.add('hidden'))
    byId('tab-'+key).classList.remove('hidden')
  }
  function renderAll(){ renderScore(); renderVentas(); renderClientes(); renderProductos() }

  function renderScore(){
    const a = analytics
    const now = new Date(); const mesesL = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']
    const a√±osHtml = Object.entries(a.ventasPorA√±o).map(([y,v])=>`<div><b>${y}:</b> ${fmtCurrency(v)}</div>`).join(' ')
    const p = a.proyeccion

    byId('tab-score').innerHTML = `
      <div class="warn" style="margin-bottom:12px"><b>üìä Datos por a√±o:</b> <span>${a√±osHtml||'‚Äî'}</span></div>
      <div class="projection" style="margin-top:8px"><h2>üéØ Proyecci√≥n del Mes (${mesesL[now.getMonth()]} ${now.getFullYear()})</h2></div>
      <div class="projection grid cols-4" style="gap:16px">
        <div><div class="muted">Meta mensual</div><div style="font-size:1.6rem;font-weight:800">${fmtCurrency(p.metaMensual)}</div></div>
        <div><div class="muted">Ventas a la fecha</div><div style="font-size:1.6rem;font-weight:800">${fmtCurrency(p.ventasMes)}</div></div>
        <div><div class="muted">Proyecci√≥n</div><div style="font-size:1.6rem;font-weight:800">${fmtCurrency(p.proyeccion)}</div><div>${(p.probabilidad||0).toFixed(0)}% prob.</div></div>
        <div><div class="muted">D√≠as restantes</div><div style="font-size:1.6rem;font-weight:800">${p.diasRestantes}</div><div>${fmtCurrency(p.ventasNecesarias)}/d√≠a</div></div>
      </div>

      <div class="grid cols-4" style="margin-top:16px">
        <div class="kpi"><h4>Ventas Totales (filtro)</h4><div class="v">${fmtCurrency(a.totalVentas)}</div></div>
        <div class="kpi"><h4>Facturas</h4><div class="v">${a.numFacturas}</div></div>
        <div class="kpi"><h4>Ticket Promedio</h4><div class="v">${fmtCurrency(a.ticketPromedio)}</div></div>
        <div class="kpi"><h4>Total Clientes</h4><div class="v">${a.totalClientes}</div></div>
      </div>

      <div class="grid cols-4" style="margin-top:16px">
        <div class="kpi"><h4>Utilidad Total</h4><div class="v">${a.utilidadTotal!=null? fmtCurrency(a.utilidadTotal):'‚Äî'}</div></div>
        <div class="kpi"><h4>Margen % (pond.)</h4><div class="v">${a.margenPonderado!=null? a.margenPonderado.toFixed(1)+'%':'‚Äî'}</div></div>
        <div class="kpi"><h4>Ventas 2024</h4><div class="v">${fmtCurrency(a.ventas2024)}</div></div>
        <div class="kpi"><h4>Ventas 2025</h4><div class="v">${fmtCurrency(a.ventas2025)}</div></div>
      </div>

      <div class="grid cols-2" style="margin-top:16px">
        <div class="card"><h3>Top 5 Clientes</h3><canvas id="chartTopClientes"></canvas></div>
        <div class="card"><h3>Top 5 Productos</h3><canvas id="chartTopProductos"></canvas></div>
      </div>
    `
    setTimeout(()=>{ drawTopClientes(); drawTopProductos(); }, 50)
  }
  function drawTopClientes(){
    const el = document.getElementById('chartTopClientes'); if(!el) return
    const top = analytics.clientes.slice(0,5)
    const data = { labels: top.map(x=>x.nombre), datasets:[{ label:'Ventas', data: top.map(x=>x.total) }] }
    charts.topClientes && charts.topClientes.destroy()
    charts.topClientes = new Chart(el,{type:'bar',data,options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>fmtCurrency(v)}}}}})
  }
  function drawTopProductos(){
    const el = document.getElementById('chartTopProductos'); if(!el) return
    const top = analytics.productos.slice(0,5)
    const data = { labels: top.map(x=>x.nombre.slice(0,30)), datasets:[{ label:'Ventas', data: top.map(x=>x.valor) }] }
    charts.topProductos && charts.topProductos.destroy()
    charts.topProductos = new Chart(el,{type:'bar',data,options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>fmtCurrency(v)}}}}})
  }

  function renderVentas(){
    const a = analytics
    byId('tab-ventas').innerHTML = `
      <div class="kpi"><h4>Crecimiento Anual</h4><div class="v" style="color:${(a.crecimientoAnual||0)>=0?'#10b981':'#ef4444'}">${(a.crecimientoAnual||0).toFixed(1)}%</div></div>
      <div class="card" style="margin-top:16px"><h3>Evoluci√≥n 2024 vs 2025</h3><canvas id="chartEvo"></canvas></div>
    `
    setTimeout(()=>{
      const el = document.getElementById('chartEvo'); if(!el) return
      const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic']
      const v24 = Array(12).fill(0), v25 = Array(12).fill(0)
      for (const r of allData){ if(!r.numFactura) continue; if(r.a√±o===2024) v24[r.mes-1]+= (r[AMOUNT_FIELD]||0); if(r.a√±o===2025) v25[r.mes-1]+= (r[AMOUNT_FIELD]||0) }
      charts.evo && charts.evo.destroy()
      charts.evo = new Chart(el,{type:'line',data:{labels:meses,datasets:[{label:'2024',data:v24},{label:'2025',data:v25}]},options:{scales:{y:{beginAtZero:true,ticks:{callback:v=>fmtCurrency(v)}}}}})
    },50)
  }

  function renderClientes(){
    const seg={VIP:0,Leal:0,Ocasional:0,Riesgo:0}
    for (const c of analytics.clientes){ seg[c.segmento]++ }
    byId('tab-clientes').innerHTML = `
      <div class="grid cols-4">
        <div class="kpi"><h4>VIP</h4><div class="v">${seg.VIP}</div></div>
        <div class="kpi"><h4>Leales</h4><div class="v">${seg.Leal}</div></div>
        <div class="kpi"><h4>Ocasionales</h4><div class="v">${seg.Ocasional}</div></div>
        <div class="kpi"><h4>En Riesgo</h4><div class="v">${seg.Riesgo}</div></div>
      </div>
      <div class="card" style="margin-top:16px">
        <h3>Top 20 Clientes</h3>
        <table><thead><tr><th>Cliente</th><th>Segmento</th><th>Ventas</th><th>Facturas</th><th>√öltima compra</th><th>D√≠as</th></tr></thead>
          <tbody>
            ${analytics.clientes.slice(0,20).map(c=>`
              <tr>
                <td>${c.nombre}</td>
                <td><span class="badge ${c.segmento}">${c.segmento}</span></td>
                <td>${fmtCurrency(c.total)}</td>
                <td>${c.facturas}</td>
                <td>${new Date(c.ultima).toLocaleDateString('es-MX')}</td>
                <td>${c.dias}</td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>`
  }

  function renderProductos(){
    byId('tab-productos').innerHTML = `
      <h3>Top 20 Productos</h3>
      <table><thead><tr><th>Producto</th><th>Categor√≠a</th><th>Cantidad</th><th>Valor</th></tr></thead>
        <tbody>
          ${analytics.productos.slice(0,20).map(p=>`
            <tr><td>${p.nombre}</td><td><span class="badge">${p.categoria||'-'}</span></td><td>${p.cantidad}</td><td>${fmtCurrency(p.valor)}</td></tr>
          `).join('')}
        </tbody>
      </table>`
  }

  // ========================
  // 9) Eventos UI
  // ========================
  document.addEventListener('click', (e)=>{
    const t = e.target
    if (t.matches('.tab')) switchTab(t.dataset.tab)
    if (t.matches('#btnLogin')) login()
    if (t.matches('#btnLogout')) logout()
    if (t.matches('#btnRefresh')) loadData()
    if (t.matches('#yearFilter, #monthFilter, #includeNoFolio')) applyFilters()
  })

  // Inicializa MSAL al cargar
  initMsal()
  </script>
</body>
</html>