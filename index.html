<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard LXA - CEO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 { color: #333; font-size: 2.5em; margin-bottom: 10px; }
        .header p { color: #666; font-size: 1.1em; }
        .login-section {
            background: white;
            padding: 60px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 500px;
            margin: 100px auto;
        }
        .login-section h2 { color: #333; margin-bottom: 20px; }
        .login-section p { color: #666; margin-bottom: 30px; }
        .btn {
            background: #5e72e4;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn:hover { background: #4c63d2; transform: translateY(-2px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-small { padding: 8px 20px; font-size: 0.9em; }
        .loading {
            text-align: center;
            padding: 100px;
            background: white;
            border-radius: 20px;
            margin: 50px auto;
            max-width: 500px;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #5e72e4;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .filters {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filters select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
        }
        .tabs {
            background: white;
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            overflow-x: auto;
        }
        .tab {
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            font-weight: 500;
        }
        .tab:hover { background: #f0f0f0; }
        .tab.active { background: #5e72e4; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .kpi-card h3 { color: #666; font-size: 0.9em; margin-bottom: 10px; text-transform: uppercase; }
        .kpi-card .value { color: #333; font-size: 2em; font-weight: bold; }
        .kpi-card .trend { font-size: 0.9em; margin-top: 8px; }
        .kpi-card .trend.up { color: #10b981; }
        .kpi-card .trend.down { color: #ef4444; }
        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            min-height: 450px;
        }
        .chart-card h3 { color: #333; margin-bottom: 20px; font-size: 1.3em; }
        .chart-container { height: 350px; position: relative; }
        .table-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .table-card h3 { color: #333; margin-bottom: 20px; font-size: 1.3em; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        tr:hover { background: #f8f9fa; }
        .alert-card {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .alert-card h3 { color: #991b1b; margin-bottom: 10px; }
        .alert-item { color: #7f1d1d; margin: 8px 0; }
        .success-card {
            background: #f0fdf4;
            border-left: 4px solid #10b981;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .success-card h3 { color: #065f46; margin-bottom: 10px; }
        .success-item { color: #064e3b; margin: 8px 0; }
        .badge { 
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .badge.A { background: #dcfce7; color: #166534; }
        .badge.B { background: #fef3c7; color: #92400e; }
        .badge.C { background: #fee2e2; color: #991b1b; }
        .error {
            background: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #c33;
        }
        .user-info {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info span { color: #333; }
        .user-info button { 
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loginSection" class="login-section">
            <h2>üîê Dashboard LXA</h2>
            <p>Inicia sesi√≥n con tu cuenta de Microsoft</p>
            <button class="btn" onclick="signIn()">Iniciar Sesi√≥n con Microsoft</button>
        </div>

        <div id="loadingSection" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <h3>Cargando datos...</h3>
        </div>

        <div id="dashboardSection" style="display: none;">
            <div class="user-info">
                <span>üë§ <strong id="userName"></strong></span>
                <button onclick="signOut()">Cerrar Sesi√≥n</button>
            </div>

            <div class="header">
                <h1>üìä Dashboard Ejecutivo LXA</h1>
                <p>An√°lisis en tiempo real para toma de decisiones</p>
                <small id="lastUpdate"></small>
            </div>

            <div class="filters">
                <label><strong>A√±o:</strong></label>
                <select id="yearFilter" onchange="applyFilters()">
                    <option value="all">Todos</option>
                </select>
                <label><strong>Mes:</strong></label>
                <select id="monthFilter" onchange="applyFilters()">
                    <option value="all">Todos</option>
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                </select>
                <button class="btn btn-small" onclick="loadData()">üîÑ Actualizar</button>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('resumen')">üìã Resumen Ejecutivo</div>
                <div class="tab" onclick="switchTab('ventas')">üìà Ventas</div>
                <div class="tab" onclick="switchTab('clientes')">üë• Clientes</div>
                <div class="tab" onclick="switchTab('productos')">üì¶ Productos</div>
                <div class="tab" onclick="switchTab('vendedores')">üéØ Vendedores</div>
                <div class="tab" onclick="switchTab('geografia')">üó∫Ô∏è Geograf√≠a</div>
            </div>

            <div id="tab-resumen" class="tab-content active"></div>
            <div id="tab-ventas" class="tab-content"></div>
            <div id="tab-clientes" class="tab-content"></div>
            <div id="tab-productos" class="tab-content"></div>
            <div id="tab-vendedores" class="tab-content"></div>
            <div id="tab-geografia" class="tab-content"></div>
        </div>

        <div id="errorSection" style="display: none;"></div>
    </div>

    <script>
        const msalConfig = {
            auth: {
                clientId: '9d480cdb-912b-4132-9882-f36d6c3b12e5',
                authority: 'https://login.microsoftonline.com/45f5b6e6-42e0-4fdd-b61a-df489f75dc8c',
                redirectUri: window.location.origin
            },
            cache: {
                cacheLocation: 'localStorage',
                storeAuthStateInCookie: true
            }
        };

        const loginRequest = {
            scopes: ['Files.Read', 'Files.Read.All', 'Sites.Read.All', 'User.Read']
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let allData = [];
        let filteredData = [];
        let analytics = {};
        let charts = {};

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        async function signIn() {
            try {
                const loginResponse = await msalInstance.loginPopup(loginRequest);
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('userName').textContent = loginResponse.account.name;
                await loadData();
            } catch (error) {
                showError('Error al iniciar sesi√≥n: ' + error.message);
            }
        }

        function signOut() {
            msalInstance.logoutPopup();
        }

        async function getAccessToken() {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length === 0) throw new Error('No hay sesi√≥n activa');

            const request = { ...loginRequest, account: accounts[0] };
            const response = await msalInstance.acquireTokenSilent(request);
            return response.accessToken;
        }

        async function loadData() {
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'none';

            try {
                const token = await getAccessToken();
                
                const sharingUrl = 'https://laidealmx-my.sharepoint.com/:x:/g/personal/carlosc_laideal_com_mx/EY8QlfTcVY9Kq3TQk3XcDusB6QsET2u1DfBFDnclSLBhXw';
                const encodedUrl = 'u!' + btoa(sharingUrl).replace(/=/g, '').replace(/\//g, '_').replace(/\+/g, '-');
                
                const shareResponse = await fetch(
                    `https://graph.microsoft.com/v1.0/shares/${encodedUrl}/driveItem`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );

                if (!shareResponse.ok) throw new Error(`Error: ${shareResponse.status}`);

                const shareData = await shareResponse.json();
                
                const contentResponse = await fetch(
                    `https://graph.microsoft.com/v1.0/drives/${shareData.parentReference.driveId}/items/${shareData.id}/content`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );

                if (!contentResponse.ok) throw new Error(`Error: ${contentResponse.status}`);

                const arrayBuffer = await contentResponse.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                const worksheet = workbook.Sheets['LXA'];
                if (!worksheet) throw new Error('No se encontr√≥ la hoja "LXA"');

                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                allData = processData(jsonData);
                filteredData = allData;
                
                updateYearFilter();
                calculateAnalytics();
                renderAllTabs();
                
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('dashboardSection').style.display = 'block';
                document.getElementById('lastUpdate').textContent = `√öltima actualizaci√≥n: ${new Date().toLocaleString('es-MX')}`;
                
            } catch (error) {
                console.error('Error:', error);
                showError('Error al cargar datos: ' + error.message);
                document.getElementById('loadingSection').style.display = 'none';
            }
        }

        function processData(data) {
            return data.map(row => {
                let fecha = null;
                const salidaValue = row['Salida'];
                
                if (typeof salidaValue === 'string' && salidaValue.includes('/')) {
                    const parts = salidaValue.split('/');
                    if (parts.length === 3) fecha = new Date(parts[2], parts[1] - 1, parts[0]);
                } else if (typeof salidaValue === 'number') {
                    fecha = new Date(new Date(1899, 11, 30).getTime() + salidaValue * 86400000);
                } else if (salidaValue instanceof Date) {
                    fecha = salidaValue;
                }

                const parsePrice = (str) => {
                    if (!str) return 0;
                    return parseFloat(str.toString().replace(/[$,]/g, '')) || 0;
                };

                const normalizarCliente = (cliente) => {
                    if (!cliente) return cliente;
                    if (cliente.toLowerCase().includes('coppel')) return 'Coppel';
                    return cliente;
                };

                return {
                    a√±o: fecha ? fecha.getFullYear() : null,
                    mes: fecha ? fecha.getMonth() + 1 : null,
                    fecha: fecha,
                    diaSemana: fecha ? fecha.getDay() : null,
                    numFactura: row['#'] || '',
                    cliente: normalizarCliente(row['Cliente']),
                    producto: row['Producto(s)'],
                    cantidad: parseInt(row['Cantidad']) || 0,
                    subtotal2: parsePrice(row['Subtotal 2']),
                    total: parsePrice(row['Total']),
                    vendedor: row['Vendedor'],
                    estado: row['Estado']
                };
            }).filter(row => row.fecha !== null);
        }

        function updateYearFilter() {
            const years = [...new Set(allData.map(row => row.a√±o))].sort();
            const yearSelect = document.getElementById('yearFilter');
            yearSelect.innerHTML = '<option value="all">Todos</option>';
            years.forEach(year => {
                yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
            });
        }

        function applyFilters() {
            const selectedYear = document.getElementById('yearFilter').value;
            const selectedMonth = document.getElementById('monthFilter').value;

            filteredData = allData.filter(row => {
                if (selectedYear !== 'all' && row.a√±o !== parseInt(selectedYear)) return false;
                if (selectedMonth !== 'all' && row.mes !== parseInt(selectedMonth)) return false;
                return true;
            });

            calculateAnalytics();
            renderAllTabs();
        }

        function calculateAnalytics() {
            const ventasConFactura = filteredData.filter(row => row.numFactura !== '');
            const totalVentas = ventasConFactura.reduce((sum, row) => sum + row.total, 0);
            const numFacturas = ventasConFactura.length;
            
            analytics = {
                totalVentas,
                numFacturas,
                ticketPromedio: numFacturas > 0 ? totalVentas / numFacturas : 0,
                ...calculateComparativas(),
                ...calculateClientAnalysis(),
                ...calculateProductAnalysis(),
                ...calculateVendedorAnalysis(),
                ...calculateGeografiaAnalysis(),
                ...calculateDiasSemanaAnalysis()
            };
        }

        function calculateComparativas() {
            const now = new Date();
            const mesActual = now.getMonth() + 1;
            const a√±oActual = now.getFullYear();

            const ventasMesActual = allData.filter(r => r.a√±o === a√±oActual && r.mes === mesActual && r.numFactura !== '')
                .reduce((sum, r) => sum + r.total, 0);
            
            const mesAnterior = mesActual === 1 ? 12 : mesActual - 1;
            const a√±oMesAnterior = mesActual === 1 ? a√±oActual - 1 : a√±oActual;
            const ventasMesAnterior = allData.filter(r => r.a√±o === a√±oMesAnterior && r.mes === mesAnterior && r.numFactura !== '')
                .reduce((sum, r) => sum + r.total, 0);
            
            const crecimientoMensual = ventasMesAnterior > 0 
                ? ((ventasMesActual - ventasMesAnterior) / ventasMesAnterior) * 100 
                : 0;

            const ventasA√±oActual = allData.filter(r => r.a√±o === a√±oActual && r.numFactura !== '')
                .reduce((sum, r) => sum + r.total, 0);
            const ventasA√±oAnterior = allData.filter(r => r.a√±o === a√±oActual - 1 && r.numFactura !== '')
                .reduce((sum, r) => sum + r.total, 0);
            const crecimientoAnual = ventasA√±oAnterior > 0 
                ? ((ventasA√±oActual - ventasA√±oAnterior) / ventasA√±oAnterior) * 100 
                : 0;

            return { crecimientoMensual, crecimientoAnual, ventasMesActual, ventasA√±oActual };
        }

        function calculateClientAnalysis() {
            const clienteStats = {};
            let totalVentasClientes = 0;

            filteredData.forEach(row => {
                if (row.numFactura !== '') {
                    if (!clienteStats[row.cliente]) {
                        clienteStats[row.cliente] = { total: 0, ultimaCompra: row.fecha };
                    }
                    clienteStats[row.cliente].total += row.total;
                    if (row.fecha > clienteStats[row.cliente].ultimaCompra) {
                        clienteStats[row.cliente].ultimaCompra = row.fecha;
                    }
                    totalVentasClientes += row.total;
                }
            });

            const clientesOrdenados = Object.entries(clienteStats)
                .map(([nombre, data]) => ({ nombre, ...data }))
                .sort((a, b) => b.total - a.total);

            let acumulado = 0;
            let clientes80 = 0;
            clientesOrdenados.forEach(c => {
                acumulado += c.total;
                if (acumulado <= totalVentasClientes * 0.8) clientes80++;
            });

            const pct80_20 = clientesOrdenados.length > 0 ? (clientes80 / clientesOrdenados.length) * 100 : 0;

            const now = new Date();
            const tresMe sesAtras = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
            const clientesInactivos = clientesOrdenados.filter(c => c.ultimaCompra < tresMe sesAtras);

            return { clientesOrdenados, pct80_20, clientesInactivos, clientes80 };
        }

        function calculateProductAnalysis() {
            const productoStats = {};
            let totalVentasProductos = 0;

            filteredData.forEach(row => {
                if (!productoStats[row.producto]) {
                    productoStats[row.producto] = { cantidad: 0, valor: 0 };
                }
                productoStats[row.producto].cantidad += row.cantidad;
                productoStats[row.producto].valor += row.subtotal2;
                totalVentasProductos += row.subtotal2;
            });

            const productosOrdenados = Object.entries(productoStats)
                .map(([nombre, stats]) => ({ nombre, ...stats }))
                .sort((a, b) => b.valor - a.valor);

            let acumulado = 0;
            const productosConCategoria = productosOrdenados.map(p => {
                acumulado += p.valor;
                const pctAcumulado = (acumulado / totalVentasProductos) * 100;
                let categoria = 'C';
                if (pctAcumulado <= 80) categoria = 'A';
                else if (pctAcumulado <= 95) categoria = 'B';
                return { ...p, categoria, pctAcumulado };
            });

            return { productosConCategoria };
        }

        function calculateVendedorAnalysis() {
            const vendedorStats = {};

            filteredData.forEach(row => {
                if (row.vendedor) {
                    if (!vendedorStats[row.vendedor]) {
                        vendedorStats[row.vendedor] = { ventas: 0, facturas: new Set(), productos: 0 };
                    }
                    if (row.numFactura !== '') {
                        vendedorStats[row.vendedor].ventas += row.total;
                        vendedorStats[row.vendedor].facturas.add(row.numFactura);
                    }
                    vendedorStats[row.vendedor].productos += row.cantidad;
                }
            });

            const vendedoresRanking = Object.entries(vendedorStats)
                .map(([nombre, stats]) => ({
                    nombre,
                    ventas: stats.ventas,
                    facturas: stats.facturas.size,
                    ticketPromedio: stats.facturas.size > 0 ? stats.ventas / stats.facturas.size : 0,
                    productosPorFactura: stats.facturas.size > 0 ? stats.productos / stats.facturas.size : 0
                }))
                .sort((a, b) => b.ventas - a.ventas);

            return { vendedoresRanking };
        }

        function calculateGeografiaAnalysis() {
            const estadoStats = {};
            const now = new Date();
            const a√±oActual = now.getFullYear();

            allData.forEach(row => {
                if (row.numFactura !== '' && row.estado) {
                    if (!estadoStats[row.estado]) {
                        estadoStats[row.estado] = { actual: 0, anterior: 0 };
                    }
                    if (row.a√±o === a√±oActual) {
                        estadoStats[row.estado].actual += row.total;
                    } else if (row.a√±o === a√±oActual - 1) {
                        estadoStats[row.estado].anterior += row.total;
                    }
                }
            });

            const estadosConCrecimiento = Object.entries(estadoStats)
                .map(([estado, data]) => ({
                    estado,
                    ventas: data.actual,
                    crecimiento: data.anterior > 0 ? ((data.actual - data.anterior) / data.anterior) * 100 : 0
                }))
                .sort((a, b) => b.crecimiento - a.crecimiento);

            return { estadosConCrecimiento };
        }

        function calculateDiasSemanaAnalysis() {
            const diasStats = {0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0};
            const diasNombres = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];

            filteredData.forEach(row => {
                if (row.numFactura !== '' && row.diaSemana !== null) {
                    diasStats[row.diaSemana] += row.total;
                }
            });

            const diasOrdenados = Object.entries(diasStats)
                .map(([dia, ventas]) => ({ dia: diasNombres[dia], ventas }))
                .sort((a, b) => b.ventas - a.ventas);

            return { diasOrdenados };
        }

        function renderAllTabs() {
            renderTabResumen();
            renderTabVentas();
            renderTabClientes();
            renderTabProductos();
            renderTabVendedores();
            renderTabGeografia();
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value);
        }

        function renderTabResumen() {
            const tab = document.getElementById('tab-resumen');
            
            const buenosItems = [];
            const alertasItems = [];

            if (analytics.crecimientoMensual > 0) {
                buenosItems.push(`Crecimiento mensual del ${analytics.crecimientoMensual.toFixed(1)}%`);
            } else {
                alertasItems.push(`Decrecimiento mensual del ${Math.abs(analytics.crecimientoMensual).toFixed(1)}%`);
            }

            if (analytics.crecimientoAnual > 0) {
                buenosItems.push(`Crecimiento anual del ${analytics.crecimientoAnual.toFixed(1)}%`);
            }

            if (analytics.clientesInactivos.length > 0) {
                alertasItems.push(`${analytics.clientesInactivos.length} clientes sin comprar en 3+ meses`);
            }

            if (analytics.pct80_20 < 30) {
                buenosItems.push(`Baja concentraci√≥n de clientes (${analytics.pct80_20.toFixed(0)}% genera el 80%)`);
            } else {
                alertasItems.push(`Alta concentraci√≥n: ${analytics.pct80_20.toFixed(0)}% de clientes genera el 80% de ventas`);
            }

            tab.innerHTML = `
                <div class="kpis">
                    <div class="kpi-card">
                        <h3>Ventas Totales</h3>
                        <div class="value">${formatCurrency(analytics.totalVentas)}</div>
                        <div class="trend ${analytics.crecimientoMensual >= 0 ? 'up' : 'down'}">
                            ${analytics.crecimientoMensual >= 0 ? '‚Üó' : '‚Üò'} ${Math.abs(analytics.crecimientoMensual).toFixed(1)}% vs mes anterior
                        </div>
                    </div>
                    <div class="kpi-card">
                        <h3>N√∫mero de Facturas</h3>
                        <div class="value">${analytics.numFacturas}</div>
                    </div>
                    <div class="kpi-card">
                        <h3>Ticket Promedio</h3>
                        <div class="value">${formatCurrency(analytics.ticketPromedio)}</div>
                    </div>
                    <div class="kpi-card">
                        <h3>Crecimiento Anual</h3>
                        <div class="value">${analytics.crecimientoAnual.toFixed(1)}%</div>
                        <div class="trend ${analytics.crecimientoAnual >= 0 ? 'up' : 'down'}">
                            ${analytics.crecimientoAnual >= 0 ? '‚Üó' : '‚Üò'} vs a√±o anterior
                        </div>
                    </div>
                </div>

                ${buenosItems.length > 0 ? `
                    <div class="success-card">
                        <h3>‚úÖ Aspectos Positivos</h3>
                        ${buenosItems.map(item => `<div class="success-item">‚Ä¢ ${item}</div>`).join('')}
                    </div>
                ` : ''}

                ${alertasItems.length > 0 ? `
                    <div class="alert-card">
                        <h3>‚ö†Ô∏è √Åreas de Atenci√≥n</h3>
                        ${alertasItems.map(item => `<div class="alert-item">‚Ä¢ ${item}</div>`).join('')}
                    </div>
                ` : ''}

                <div class="charts">
                    <div class="chart-card">
                        <h3>Top 5 Clientes</h3>
                        <div class="chart-container">
                            <canvas id="chartTopClientes"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Top 5 Productos</h3>
                        <div class="chart-container">
                            <canvas id="chartTopProductos"></canvas>
                        </div>
                    </div>
                </div>

                <div class="charts">
                    <div class="chart-card">
                        <h3>Ventas por D√≠a de la Semana</h3>
                        <div class="chart-container">
                            <canvas id="chartDiasSemana"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Top 3 Vendedores</h3>
                        <div class="chart-container">
                            <canvas id="chartTopVendedores"></canvas>
                        </div>
                    </div>
                </div>
            `;

            setTimeout(() => {
                createTopClientesChart();
                createTopProductosChart();
                createDiasSemanaChart();
                createTopVendedoresChart();
            }, 100);
        }

        function createTopClientesChart() {
            const ctx = document.getElementById('chartTopClientes');
            if (!ctx) return;

            if (charts.topClientes) charts.topClientes.destroy();

            const top5 = analytics.clientesOrdenados.slice(0, 5);
            charts.topClientes = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top5.map(c => c.nombre),
                    datasets: [{
                        label: 'Ventas',
                        data: top5.map(c => c.total),
                        backgroundColor: '#5e72e4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        function createTopProductosChart() {
            const ctx = document.getElementById('chartTopProductos');
            if (!ctx) return;

            if (charts.topProductos) charts.topProductos.destroy();

            const top5 = analytics.productosConCategoria.slice(0, 5);
            charts.topProductos = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top5.map(p => p.nombre),
                    datasets: [{
                        label: 'Ventas',
                        data: top5.map(p => p.valor),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        function createDiasSemanaChart() {
            const ctx = document.getElementById('chartDiasSemana');
            if (!ctx) return;

            if (charts.diasSemana) charts.diasSemana.destroy();

            charts.diasSemana = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: analytics.diasOrdenados.map(d => d.dia),
                    datasets: [{
                        label: 'Ventas',
                        data: analytics.diasOrdenados.map(d => d.ventas),
                        backgroundColor: '#f59e0b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        function createTopVendedoresChart() {
            const ctx = document.getElementById('chartTopVendedores');
            if (!ctx) return;

            if (charts.topVendedores) charts.topVendedores.destroy();

            const top3 = analytics.vendedoresRanking.slice(0, 3);
            charts.topVendedores = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top3.map(v => v.nombre),
                    datasets: [{
                        label: 'Ventas',
                        data: top3.map(v => v.ventas),
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        function renderTabVentas() {
            const tab = document.getElementById('tab-ventas');

            const ventasPorMes = {};
            const years = [...new Set(allData.map(r => r.a√±o))].sort();
            
            allData.forEach(row => {
                if (row.numFactura !== '') {
                    const key = `${row.a√±o}-${row.mes}`;
                    if (!ventasPorMes[key]) {
                        ventasPorMes[key] = { a√±o: row.a√±o, mes: row.mes, total: 0 };
                    }
                    ventasPorMes[key].total += row.total;
                }
            });

            const ventasArray = Object.values(ventasPorMes).sort((a, b) => {
                if (a.a√±o !== b.a√±o) return a.a√±o - b.a√±o;
                return a.mes - b.mes;
            });

            tab.innerHTML = `
                <div class="kpis">
                    <div class="kpi-card">
                        <h3>Crecimiento Mensual</h3>
                        <div class="value ${analytics.crecimientoMensual >= 0 ? 'trend up' : 'trend down'}">${analytics.crecimientoMensual.toFixed(1)}%</div>
                    </div>
                    <div class="kpi-card">
                        <h3>Crecimiento Anual</h3>
                        <div class="value ${analytics.crecimientoAnual >= 0 ? 'trend up' : 'trend down'}">${analytics.crecimientoAnual.toFixed(1)}%</div>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Evoluci√≥n de Ventas Mes a Mes</h3>
                    <div class="chart-container">
                        <canvas id="chartVentasMes"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Comparativo A√±o vs A√±o</h3>
                    <div class="chart-container">
                        <canvas id="chartComparativoAnual"></canvas>
                    </div>
                </div>
            `;

            setTimeout(() => {
                createVentasMesChart(ventasArray);
                createComparativoAnualChart(years);
            }, 100);
        }

        function createVentasMesChart(ventasArray) {
            const ctx = document.getElementById('chartVentasMes');
            if (!ctx) return;

            if (charts.ventasMes) charts.ventasMes.destroy();

            const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

            charts.ventasMes = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ventasArray.map(v => `${meses[v.mes - 1]} ${v.a√±o}`),
                    datasets: [{
                        label: 'Ventas',
                        data: ventasArray.map(v => v.total),
                        borderColor: '#5e72e4',
                        backgroundColor: 'rgba(94, 114, 228, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        function createComparativoAnualChart(years) {
            const ctx = document.getElementById('chartComparativoAnual');
            if (!ctx) return;

            if (charts.comparativoAnual) charts.comparativoAnual.destroy();

            const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const datasets = [];
            const colors = ['#5e72e4', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];

            years.forEach((year, idx) => {
                const ventasMes = Array(12).fill(0);
                
                allData.forEach(row => {
                    if (row.a√±o === year && row.numFactura !== '') {
                        ventasMes[row.mes - 1] += row.total;
                    }
                });

                datasets.push({
                    label: year.toString(),
                    data: ventasMes,
                    borderColor: colors[idx % colors.length],
                    tension: 0.4
                });
            });

            charts.comparativoAnual = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: meses,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        function renderTabClientes() {
            const tab = document.getElementById('tab-clientes');

            tab.innerHTML = `
                <div class="kpis">
                    <div class="kpi-card">
                        <h3>Total Clientes</h3>
                        <div class="value">${analytics.clientesOrdenados.length}</div>
                    </div>
                    <div class="kpi-card">
                        <h3>Clientes Inactivos (3+ meses)</h3>
                        <div class="value">${analytics.clientesInactivos.length}</div>
                    </div>
                    <div class="kpi-card">
                        <h3>Concentraci√≥n 80/20</h3>
                        <div class="value">${analytics.pct80_20.toFixed(0)}%</div>
                        <div style="font-size: 0.9em; margin-top: 8px;">de clientes genera el 80% de ventas</div>
                    </div>
                </div>

                ${analytics.clientesInactivos.length > 0 ? `
                    <div class="alert-card">
                        <h3>‚ö†Ô∏è Clientes Inactivos (sin compra en 3+ meses)</h3>
                        ${analytics.clientesInactivos.slice(0, 10).map(c => 
                            `<div class="alert-item">‚Ä¢ ${c.nombre} - √öltima compra: ${c.ultimaCompra.toLocaleDateString('es-MX')}</div>`
                        ).join('')}
                    </div>
                ` : ''}

                <div class="chart-card">
                    <h3>Concentraci√≥n de Clientes (Regla 80/20)</h3>
                    <div class="chart-container">
                        <canvas id="chartConcentracion"></canvas>
                    </div>
                </div>

                <div class="table-card">
                    <h3>Ranking de Clientes</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Cliente</th>
                                <th>Ventas Totales</th>
                                <th>% del Total</th>
                                <th>√öltima Compra</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${analytics.clientesOrdenados.map((c, idx) => `
                                <tr>
                                    <td>${idx + 1}</td>
                                    <td>${c.nombre}</td>
                                    <td>${formatCurrency(c.total)}</td>
                                    <td>${((c.total / analytics.totalVentas) * 100).toFixed(1)}%</td>
                                    <td>${c.ultimaCompra.toLocaleDateString('es-MX')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            setTimeout(() => createConcentracionChart(), 100);
        }

        function createConcentracionChart() {
            const ctx = document.getElementById('chartConcentracion');
            if (!ctx) return;

            if (charts.concentracion) charts.concentracion.destroy();

            let acumulado = 0;
            const pctAcumulados = analytics.clientesOrdenados.map(c => {
                acumulado += c.total;
                return (acumulado / analytics.totalVentas) * 100;
            });

            charts.concentracion = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: analytics.clientesOrdenados.map((c, idx) => idx + 1),
                    datasets: [{
                        label: '% Acumulado de Ventas',
                        data: pctAcumulados,
                        borderColor: '#5e72e4',
                        backgroundColor: 'rgba(94, 114, 228, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'L√≠nea 80/20',
                        data: Array(analytics.clientesOrdenados.length).fill(80),
                        borderColor: '#ef4444',
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'N√∫mero de Clientes' } },
                        y: { 
                            title: { display: true, text: '% Acumulado' },
                            max: 100
                        }
                    }
                }
            });
        }

        function renderTabProductos() {
            const tab = document.getElementById('tab-productos');

            const productosA = analytics.productosConCategoria.filter(p => p.categoria === 'A');
            const productosB = analytics.productosConCategoria.filter(p => p.categoria === 'B');
            const productosC = analytics.productosConCategoria.filter(p => p.categoria === 'C');

            tab.innerHTML = `
                <div class="kpis">
                    <div class="kpi-card">
                        <h3>Productos Categor√≠a A</h3>
                        <div class="value">${productosA.length}</div>
                        <div style="font-size: 0.9em; margin-top: 8px;">Top 80% de ventas</div>
                    </div>
                    <div class="kpi-card">
                        <h3>Productos Categor√≠a B</h3>
                        <div class="value">${productosB.length}</div>
                        <div style="font-size: 0.9em; margin-top: 8px;">Siguiente 15% de ventas</div>
                    </div>
                    <div class="kpi-card">
                        <h3>Productos Categor√≠a C</h3>
                        <div class="value">${productosC.length}</div>
                        <div style="font-size: 0.9em; margin-top: 8px;">√öltimo 5% de ventas</div>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Top 10 Productos por Ventas</h3>
                    <div class="chart-container">
                        <canvas id="chartTopProductosDetalle"></canvas>
                    </div>
                </div>

                <div class="table-card">
                    <h3>An√°lisis ABC de Productos</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Producto</th>
                                <th>Categor√≠a</th>
                                <th>Cantidad Vendida</th>
                                <th>Valor Total</th>
                                <th>% del Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${analytics.productosConCategoria.map((p, idx) => `
                                <tr>
                                    <td>${idx + 1}</td>
                                    <td>${p.nombre}</td>
                                    <td><span class="badge ${p.categoria}">${p.categoria}</span></td>
                                    <td>${p.cantidad}</td>
                                    <td>${formatCurrency(p.valor)}</td>
                                    <td>${((p.valor / analytics.totalVentas) * 100).toFixed(1)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            setTimeout(() => createTopProductosDetalleChart(), 100);
        }

        function createTopProductosDetalleChart() {
            const ctx = document.getElementById('chartTopProductosDetalle');
            if (!ctx) return;

            if (charts.topProductosDetalle) charts.topProductosDetalle.destroy();

            const top10 = analytics.productosConCategoria.slice(0, 10);

            charts.topProductosDetalle = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(p => p.nombre),
                    datasets: [{
                        label: 'Ventas',
                        data: top10.map(p => p.valor),
                        backgroundColor: top10.map(p => {
                            if (p.categoria === 'A') return '#10b981';
                            if (p.categoria === 'B') return '#f59e0b';
                            return '#ef4444';
                        })
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        function renderTabVendedores() {
            const tab = document.getElementById('tab-vendedores');

            tab.innerHTML = `
                <div class="kpis">
                    <div class="kpi-card">
                        <h3>Total Vendedores</h3>
                        <div class="value">${analytics.vendedoresRanking.length}</div>
                    </div>
                    <div class="kpi-card">
                        <h3>Ticket Promedio General</h3>
                        <div class="value">${formatCurrency(analytics.ticketPromedio)}</div>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Ventas por Vendedor</h3>
                    <div class="chart-container">
                        <canvas id="chartVendedoresVentas"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Ticket Promedio por Vendedor</h3>
                    <div class="chart-container">
                        <canvas id="chartVendedoresTicket"></canvas>
                    </div>
                </div>

                <div class="table-card">
                    <h3>Ranking de Vendedores</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Vendedor</th>
                                <th>Ventas Totales</th>
                                <th>Facturas</th>
                                <th>Ticket Promedio</th>
                                <th>Productos por Factura</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${analytics.vendedoresRanking.map((v, idx) => `
                                <tr>
                                    <td>${idx + 1}</td>
                                    <td>${v.nombre}</td>
                                    <td>${formatCurrency(v.ventas)}</td>
                                    <td>${v.facturas}</td>
                                    <td>${formatCurrency(v.ticketPromedio)}</td>
                                    <td>${v.productosPorFactura.toFixed(1)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            setTimeout(() => {
                createVendedoresVentasChart();
                createVendedoresTicketChart();
            }, 100);
        }

        function createVendedoresVentasChart() {
            const ctx = document.getElementById('chartVendedoresVentas');
            if (!ctx) return;

            if (charts.vendedoresVentas) charts.vendedoresVentas.destroy();

            charts.vendedoresVentas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: analytics.vendedoresRanking.map(v => v.nombre),
                    datasets: [{
                        label: 'Ventas',
                        data: analytics.vendedoresRanking.map(v => v.ventas),
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        function createVendedoresTicketChart() {
            const ctx = document.getElementById('chartVendedoresTicket');
            if (!ctx) return;

            if (charts.vendedoresTicket) charts.vendedoresTicket.destroy();

            charts.vendedoresTicket = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: analytics.vendedoresRanking.map(v => v.nombre),
                    datasets: [{
                        label: 'Ticket Promedio',
                        data: analytics.vendedoresRanking.map(v => v.ticketPromedio),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        function renderTabGeografia() {
            const tab = document.getElementById('tab-geografia');

            tab.innerHTML = `
                <div class="chart-card">
                    <h3>Ventas por Estado</h3>
                    <div class="chart-container">
                        <canvas id="chartEstadosVentas"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Crecimiento por Estado (A√±o vs A√±o)</h3>
                    <div class="chart-container">
                        <canvas id="chartEstadosCrecimiento"></canvas>
                    </div>
                </div>

                <div class="table-card">
                    <h3>An√°lisis por Estado</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Estado</th>
                                <th>Ventas 2025</th>
                                <th>Crecimiento vs 2024</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${analytics.estadosConCrecimiento.map((e, idx) => `
                                <tr>
                                    <td>${idx + 1}</td>
                                    <td>${e.estado}</td>
                                    <td>${formatCurrency(e.ventas)}</td>
                                    <td class="${e.crecimiento >= 0 ? 'trend up' : 'trend down'}">
                                        ${e.crecimiento >= 0 ? '‚Üó' : '‚Üò'} ${Math.abs(e.crecimiento).toFixed(1)}%
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            setTimeout(() => {
                createEstadosVentasChart();
                createEstadosCrecimientoChart();
            }, 100);
        }

        function createEstadosVentasChart() {
            const ctx = document.getElementById('chartEstadosVentas');
            if (!ctx) return;

            if (charts.estadosVentas) charts.estadosVentas.destroy();

            const top10 = analytics.estadosConCrecimiento.slice(0, 10);

            charts.estadosVentas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(e => e.estado),
                    datasets: [{
                        label: 'Ventas 2025',
                        data: top10.map(e => e.ventas),
                        backgroundColor: '#5e72e4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        function createEstadosCrecimientoChart() {
            const ctx = document.getElementById('chartEstadosCrecimiento');
            if (!ctx) return;

            if (charts.estadosCrecimiento) charts.estadosCrecimiento.destroy();

            const top10 = analytics.estadosConCrecimiento.slice(0, 10);

            charts.estadosCrecimiento = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(e => e.estado),
                    datasets: [{
                        label: 'Crecimiento %',
                        data: top10.map(e => e.crecimiento),
                        backgroundColor: top10.map(e => e.crecimiento >= 0 ? '#10b981' : '#ef4444')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: value => value + '%'
                            }
                        }
                    }
                }
            });
        }

        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            errorSection.innerHTML = `<div class="error"><strong>Error:</strong> ${message}</div>`;
            errorSection.style.display = 'block';
        }

        msalInstance.handleRedirectPromise().then(response => {
            if (response) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('userName').textContent = response.account.name;
                loadData();
            }
        });
    </script>
</body>
</html>
