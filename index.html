<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard CEO - LXA</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .btn {
            background: #5e72e4;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
        }
        .btn:hover { background: #4c63d2; }
        .btn-small { padding: 8px 20px; font-size: 0.9em; }
        .hidden { display: none; }
        .filters {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filters select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }
        .tabs {
            background: white;
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            overflow-x: auto;
        }
        .tab {
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            font-weight: 500;
        }
        .tab:hover { background: #f0f0f0; }
        .tab.active { background: #5e72e4; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .kpi-card h3 { color: #666; font-size: 0.9em; margin-bottom: 10px; text-transform: uppercase; }
        .kpi-card .value { color: #333; font-size: 2em; font-weight: bold; }
        .kpi-card .trend { font-size: 0.9em; margin-top: 8px; }
        .kpi-card .trend.up { color: #10b981; }
        .kpi-card .trend.down { color: #ef4444; }
        .projection-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .projection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .projection-item h4 { font-size: 0.9em; opacity: 0.9; margin-bottom: 5px; }
        .projection-item .value { font-size: 2em; font-weight: bold; }
        .alert-card {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .alert-card h3 { color: #991b1b; margin-bottom: 10px; }
        .alert-item { color: #7f1d1d; margin: 8px 0; }
        .success-card {
            background: #f0fdf4;
            border-left: 4px solid #10b981;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .success-card h3 { color: #065f46; margin-bottom: 10px; }
        .warning-card {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .warning-card h3 { color: #92400e; margin-bottom: 10px; }
        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            min-height: 400px;
        }
        .chart-card h3 { color: #333; margin-bottom: 20px; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th { background: #f8f9fa; font-weight: 600; }
        tr:hover { background: #f8f9fa; }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .badge.VIP { background: #ddd6fe; color: #5b21b6; }
        .badge.Leal { background: #dcfce7; color: #166534; }
        .badge.Ocasional { background: #fef3c7; color: #92400e; }
        .badge.Riesgo { background: #fee2e2; color: #991b1b; }
        .badge.A { background: #dcfce7; color: #166534; }
        .badge.B { background: #fef3c7; color: #92400e; }
        .badge.C { background: #fee2e2; color: #991b1b; }
        .status-indicator {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em;
            margin: 0 auto 20px;
        }
        .status-indicator.good { background: #dcfce7; }
        .status-indicator.warning { background: #fef3c7; }
        .status-indicator.bad { background: #fee2e2; }
    </style>
</head>
<body>
    <div class="container">
        <!-- PANTALLA DE LOGIN -->
        <div id="loginCard" class="card" style="text-align: center; max-width: 500px; margin: 100px auto;">
            <h1>üîê Dashboard CEO - LXA</h1>
            <p style="margin: 20px 0;">Inicia sesi√≥n con tu cuenta de Microsoft</p>
            <button class="btn" onclick="login()">Iniciar Sesi√≥n con Microsoft</button>
        </div>

        <!-- DASHBOARD PRINCIPAL -->
        <div id="dashboard" class="hidden">
            <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üìä Dashboard CEO - LXA</h1>
                    <p id="userInfo"></p>
                    <small id="lastUpdate"></small>
                </div>
                <button class="btn" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>

            <!-- FILTROS -->
            <div class="filters">
                <label><strong>A√±o:</strong></label>
                <select id="yearFilter" onchange="applyFilters()">
                    <option value="all">Todos</option>
                </select>
                <label><strong>Mes:</strong></label>
                <select id="monthFilter" onchange="applyFilters()">
                    <option value="all">Todos</option>
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                </select>
                <button class="btn btn-small" onclick="loadData()">üîÑ Actualizar</button>
            </div>

            <!-- PESTA√ëAS -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('scorecard')">üéØ CEO Scorecard</div>
                <div class="tab" onclick="switchTab('ventas')">üìà Ventas</div>
                <div class="tab" onclick="switchTab('clientes')">üë• Clientes</div>
                <div class="tab" onclick="switchTab('productos')">üì¶ Productos</div>
                <div class="tab" onclick="switchTab('vendedores')">üéØ Vendedores</div>
                <div class="tab" onclick="switchTab('geografia')">üó∫Ô∏è Geograf√≠a</div>
            </div>

            <!-- CONTENIDO DE PESTA√ëAS -->
            <div id="tab-scorecard" class="tab-content active"></div>
            <div id="tab-ventas" class="tab-content"></div>
            <div id="tab-clientes" class="tab-content"></div>
            <div id="tab-productos" class="tab-content"></div>
            <div id="tab-vendedores" class="tab-content"></div>
            <div id="tab-geografia" class="tab-content"></div>
        </div>
    </div>

    <script>
    var CONFIG = {
        metaCrecimiento2025: 0.15,
        diasClienteInactivo: 60,
        topClientes: 10,
        umbralCaidaVendedor: 0.20,
        umbralCaidaProducto: 0.30
    };

    var msalConfig = {
        auth: {
            clientId: '9d480cdb-912b-4132-9882-f36d6c3b12e5',
            authority: 'https://login.microsoftonline.com/45f5b6e6-42e0-4fdd-b61a-df489f75dc8c',
            redirectUri: window.location.origin
        }
    };

    var msalInstance = new msal.PublicClientApplication(msalConfig);
    var allData = [];
    var filteredData = [];
    var analytics = {};
    var charts = {};

    function login() {
        msalInstance.loginPopup({
            scopes: ['Files.Read', 'User.Read']
        }).then(function(response) {
            document.getElementById('loginCard').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('userInfo').textContent = 'Usuario: ' + response.account.name;
            document.getElementById('tab-scorecard').innerHTML = '<div class="card"><h3>Cargando datos...</h3><p>Por favor espera mientras se cargan los datos desde SharePoint.</p></div>';
            loadData();
        }).catch(function(error) {
            alert('Error al iniciar sesi√≥n: ' + error);
        });
    }

    function logout() {
        msalInstance.logoutPopup();
    }

    function loadData() {
        var accounts = msalInstance.getAllAccounts();
        if (accounts.length === 0) {
            alert('No hay cuentas activas');
            return;
        }

        msalInstance.acquireTokenSilent({
            scopes: ['Files.Read'],
            account: accounts[0]
        }).then(function(response) {
            console.log('Token obtenido correctamente');
            var token = response.accessToken;
            var sharingUrl = 'https://laidealmx-my.sharepoint.com/:x:/g/personal/carlosc_laideal_com_mx/EY8QlfTcVY9Kq3TQk3XcDusB6QsET2u1DfBFDnclSLBhXw';
            var encodedUrl = 'u!' + btoa(sharingUrl).replace(/=/g, '').replace(/\//g, '_').replace(/\+/g, '-');
            
            console.log('Conectando a SharePoint...');
            
            fetch('https://graph.microsoft.com/v1.0/shares/' + encodedUrl + '/driveItem', {
                headers: { 'Authorization': 'Bearer ' + token }
            }).then(function(res) {
                console.log('Metadata obtenida, status:', res.status);
                if (!res.ok) throw new Error('Error al obtener metadata: ' + res.status);
                return res.json();
            }).then(function(shareData) {
                console.log('Descargando archivo...');
                return fetch('https://graph.microsoft.com/v1.0/drives/' + shareData.parentReference.driveId + '/items/' + shareData.id + '/content', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
            }).then(function(res) {
                console.log('Archivo descargado, status:', res.status);
                if (!res.ok) throw new Error('Error al descargar archivo: ' + res.status);
                return res.arrayBuffer();
            }).then(function(buffer) {
                console.log('Procesando Excel...');
                var workbook = XLSX.read(buffer, { type: 'array' });
                console.log('Hojas disponibles:', workbook.SheetNames);
                
                var worksheet = workbook.Sheets['LXA'];
                if (!worksheet) {
                    throw new Error('No se encontr√≥ la hoja LXA en el archivo');
                }
                
                var jsonData = XLSX.utils.sheet_to_json(worksheet);
                console.log('Registros encontrados:', jsonData.length);
                
                processData(jsonData);
                document.getElementById('lastUpdate').textContent = '√öltima actualizaci√≥n: ' + new Date().toLocaleString('es-MX');
                console.log('Datos procesados correctamente');
            }).catch(function(error) {
                console.error('Error completo:', error);
                var errorMsg = '<div class="card" style="background: #fee; border-left: 4px solid #c33; padding: 20px;">';
                errorMsg += '<h3 style="color: #c33;">Error al cargar datos</h3>';
                errorMsg += '<p><strong>Mensaje:</strong> ' + error.message + '</p>';
                errorMsg += '<p><strong>Sugerencias:</strong></p>';
                errorMsg += '<ul><li>Verifica que la URL de SharePoint sea correcta</li>';
                errorMsg += '<li>Aseg√∫rate de tener permisos para acceder al archivo</li>';
                errorMsg += '<li>Revisa la consola del navegador (F12) para m√°s detalles</li></ul></div>';
                document.getElementById('tab-scorecard').innerHTML = errorMsg;
            });
        }).catch(function(error) {
            console.error('Error al obtener token:', error);
            alert('Error al obtener token de acceso: ' + error.message);
        });
    }

    function processData(data) {
        console.log('Iniciando procesamiento de', data.length, 'registros...');
        allData = [];
        
        for (var i = 0; i < data.length; i++) {
            var row = data[i];
            
            var fecha = null;
            var salidaValue = row['Salida'];
            
            if (typeof salidaValue === 'string' && salidaValue.includes('/')) {
                var parts = salidaValue.split('/');
                if (parts.length === 3) {
                    fecha = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            } else if (typeof salidaValue === 'number') {
                var excelEpoch = new Date(1899, 11, 30);
                fecha = new Date(excelEpoch.getTime() + salidaValue * 86400000);
            } else if (salidaValue instanceof Date) {
                fecha = salidaValue;
            }
            
            var total = parseFloat((row['Total'] || '').toString().replace(/[$,]/g, '')) || 0;
            var subtotal = parseFloat((row['Subtotal 2'] || '').toString().replace(/[$,]/g, '')) || 0;
            var precio = parseFloat((row['Precio'] || '').toString().replace(/[$,]/g, '')) || 0;
            var descuento = parseFloat((row['Descuento'] || '').toString().replace(/[$,]/g, '')) || 0;
            
            if (fecha) {
                allData.push({
                    a√±o: fecha.getFullYear(),
                    mes: fecha.getMonth() + 1,
                    fecha: fecha,
                    diaSemana: fecha.getDay(),
                    numFactura: row['#'] || '',
                    cliente: row['Cliente'] || '',
                    producto: row['Producto(s)'] || '',
                    cantidad: parseInt(row['Cantidad']) || 0,
                    precio: precio,
                    descuento: descuento,
                    subtotal: subtotal,
                    total: total,
                    vendedor: row['Vendedor'] || '',
                    estado: row['Estado'] || ''
                });
            }
        }
        
        console.log('Datos procesados:', allData.length, 'registros v√°lidos');
        
        if (allData.length === 0) {
            document.getElementById('tab-scorecard').innerHTML = '<div class="card"><h3 style="color: #c33;">‚ö†Ô∏è No se encontraron datos v√°lidos</h3></div>';
            return;
        }
        
        filteredData = allData;
        updateYearFilter();
        calculateAnalytics();
        renderAllTabs();
        
        console.log('Dashboard renderizado correctamente');
    }

    function updateYearFilter() {
        var years = [];
        for (var i = 0; i < allData.length; i++) {
            if (years.indexOf(allData[i].a√±o) === -1) {
                years.push(allData[i].a√±o);
            }
        }
        years.sort();
        
        var select = document.getElementById('yearFilter');
        select.innerHTML = '<option value="all">Todos</option>';
        for (var i = 0; i < years.length; i++) {
            select.innerHTML += '<option value="' + years[i] + '">' + years[i] + '</option>';
        }
    }

    function applyFilters() {
        var selectedYear = document.getElementById('yearFilter').value;
        var selectedMonth = document.getElementById('monthFilter').value;
        
        filteredData = [];
        for (var i = 0; i < allData.length; i++) {
            var row = allData[i];
            var include = true;
            
            if (selectedYear !== 'all' && row.a√±o !== parseInt(selectedYear)) {
                include = false;
            }
            if (selectedMonth !== 'all' && row.mes !== parseInt(selectedMonth)) {
                include = false;
            }
            
            if (include) {
                filteredData.push(row);
            }
        }
        
        calculateAnalytics();
        renderAllTabs();
    }

    function calculateAnalytics() {
        calculateVentasBasicas();
        calculateMetas();
        calculateTendencias();
        calculateClientes();
        calculateProductos();
        calculateVendedores();
        calculateGeografia();
        calculateProyeccion();
        calculateAlertas();
    }

    function calculateVentasBasicas() {
        var ventasConFactura = [];
        for (var i = 0; i < filteredData.length; i++) {
            if (filteredData[i].numFactura) {
                ventasConFactura.push(filteredData[i]);
            }
        }
        
        var totalVentas = 0;
        var totalDescuentos = 0;
        for (var i = 0; i < ventasConFactura.length; i++) {
            totalVentas += ventasConFactura[i].total;
            totalDescuentos += ventasConFactura[i].descuento;
        }
        
        analytics.totalVentas = totalVentas;
        analytics.numFacturas = ventasConFactura.length;
        analytics.ticketPromedio = ventasConFactura.length > 0 ? totalVentas / ventasConFactura.length : 0;
        analytics.totalDescuentos = totalDescuentos;
        analytics.pctDescuento = totalVentas > 0 ? (totalDescuentos / totalVentas) * 100 : 0;
    }

    function calculateMetas() {
        var ventasPorA√±o = {};
        
        for (var i = 0; i < allData.length; i++) {
            if (allData[i].numFactura) {
                var a√±o = allData[i].a√±o;
                if (!ventasPorA√±o[a√±o]) ventasPorA√±o[a√±o] = 0;
                ventasPorA√±o[a√±o] += allData[i].total;
            }
        }
        
        var ventas2024 = ventasPorA√±o[2024] || 0;
        var ventas2025 = ventasPorA√±o[2025] || 0;
        var meta2025 = ventas2024 * (1 + CONFIG.metaCrecimiento2025);
        var avance = meta2025 > 0 ? (ventas2025 / meta2025) * 100 : 0;
        var crecimiento = ventas2024 > 0 ? ((ventas2025 - ventas2024) / ventas2024) * 100 : 0;
        
        analytics.ventas2024 = ventas2024;
        analytics.ventas2025 = ventas2025;
        analytics.meta2025 = meta2025;
        analytics.avanceVsMeta = avance;
        analytics.crecimientoAnual = crecimiento;
        analytics.ventasPorA√±o = ventasPorA√±o;
    }

    function calculateTendencias() {
        var ventasPorMes = {};
        var ventasPorDia = {};
        
        for (var i = 0; i < allData.length; i++) {
            if (allData[i].numFactura) {
                var key = allData[i].a√±o + '-' + allData[i].mes;
                if (!ventasPorMes[key]) ventasPorMes[key] = 0;
                ventasPorMes[key] += allData[i].total;
                
                var diaSemana = allData[i].diaSemana;
                if (!ventasPorDia[diaSemana]) ventasPorDia[diaSemana] = 0;
                ventasPorDia[diaSemana] += allData[i].total;
            }
        }
        
        analytics.ventasPorMes = ventasPorMes;
        analytics.ventasPorDia = ventasPorDia;
    }

    function calculateClientes() {
        var clienteStats = {};
        var clientesPorMes = {};
        
        for (var i = 0; i < filteredData.length; i++) {
            var row = filteredData[i];
            if (row.numFactura && row.cliente) {
                if (!clienteStats[row.cliente]) {
                    clienteStats[row.cliente] = {
                        total: 0,
                        facturas: 0,
                        primeraCompra: row.fecha,
                        ultimaCompra: row.fecha,
                        productos: 0
                    };
                }
                clienteStats[row.cliente].total += row.total;
                clienteStats[row.cliente].facturas++;
                clienteStats[row.cliente].productos += row.cantidad;
                
                if (row.fecha < clienteStats[row.cliente].primeraCompra) {
                    clienteStats[row.cliente].primeraCompra = row.fecha;
                }
                if (row.fecha > clienteStats[row.cliente].ultimaCompra) {
                    clienteStats[row.cliente].ultimaCompra = row.fecha;
                }
                
                var mesKey = row.a√±o + '-' + row.mes;
                if (!clientesPorMes[mesKey]) clientesPorMes[mesKey] = new Set();
                clientesPorMes[mesKey].add(row.cliente);
            }
        }
        
        var clientesArray = [];
        var totalVentasClientes = 0;
        
        for (var cliente in clienteStats) {
            var stats = clienteStats[cliente];
            totalVentasClientes += stats.total;
            var diasSinCompra = Math.floor((new Date() - stats.ultimaCompra) / (1000 * 60 * 60 * 24));
            var esNuevo = new Date() - stats.primeraCompra < (90 * 24 * 60 * 60 * 1000);
            
            var segmento = 'Ocasional';
            if (diasSinCompra <= 30 && stats.facturas >= 5) {
                segmento = 'VIP';
            } else if (diasSinCompra <= 60 && stats.facturas >= 3) {
                segmento = 'Leal';
            } else if (diasSinCompra > 90) {
                segmento = 'Riesgo';
            }
            
            clientesArray.push({
                nombre: cliente,
                total: stats.total,
                facturas: stats.facturas,
                productos: stats.productos,
                primeraCompra: stats.primeraCompra,
                ultimaCompra: stats.ultimaCompra,
                diasSinCompra: diasSinCompra,
                segmento: segmento,
                esNuevo: esNuevo,
                ticketPromedio: stats.total / stats.facturas
            });
        }
        
        clientesArray.sort(function(a, b) { return b.total - a.total; });
        
        var acumulado = 0;
        for (var i = 0; i < clientesArray.length; i++) {
            acumulado += clientesArray[i].total;
            clientesArray[i].pctAcumulado = (acumulado / totalVentasClientes) * 100;
        }
        
        var inactivos = [];
        var nuevos = [];
        for (var i = 0; i < clientesArray.length; i++) {
            if (clientesArray[i].diasSinCompra > CONFIG.diasClienteInactivo) {
                inactivos.push(clientesArray[i]);
            }
            if (clientesArray[i].esNuevo) {
                nuevos.push(clientesArray[i]);
            }
        }
        
        analytics.clientes = clientesArray;
        analytics.totalClientes = clientesArray.length;
        analytics.clientesInactivos = inactivos;
        analytics.clientesNuevos = nuevos;
        analytics.clientesPorMes = clientesPorMes;
    }

    function calculateProductos() {
        var productoStats = {};
        var totalVentasProductos = 0;
        
        for (var i = 0; i < filteredData.length; i++) {
            var row = filteredData[i];
            if (row.producto) {
                if (!productoStats[row.producto]) {
                    productoStats[row.producto] = {
                        cantidad: 0,
                        valor: 0,
                        facturas: 0,
                        ultimaVenta: row.fecha
                    };
                }
                productoStats[row.producto].cantidad += row.cantidad;
                productoStats[row.producto].valor += row.subtotal;
                totalVentasProductos += row.subtotal;
                if (row.numFactura) productoStats[row.producto].facturas++;
                if (row.fecha > productoStats[row.producto].ultimaVenta) {
                    productoStats[row.producto].ultimaVenta = row.fecha;
                }
            }
        }
        
        var productosArray = [];
        for (var producto in productoStats) {
            var diasSinVenta = Math.floor((new Date() - productoStats[producto].ultimaVenta) / (1000 * 60 * 60 * 24));
            productosArray.push({
                nombre: producto,
                cantidad: productoStats[producto].cantidad,
                valor: productoStats[producto].valor,
                facturas: productoStats[producto].facturas,
                diasSinVenta: diasSinVenta
            });
        }
        
        productosArray.sort(function(a, b) { return b.valor - a.valor; });
        
        var acumulado = 0;
        for (var i = 0; i < productosArray.length; i++) {
            acumulado += productosArray[i].valor;
            var pctAcum = (acumulado / totalVentasProductos) * 100;
            
            if (pctAcum <= 80) {
                productosArray[i].categoria = 'A';
            } else if (pctAcum <= 95) {
                productosArray[i].categoria = 'B';
            } else {
                productosArray[i].categoria = 'C';
            }
        }
        
        analytics.productos = productosArray;
    }

    function calculateVendedores() {
        var vendedorStats = {};
        
        for (var i = 0; i < filteredData.length; i++) {
            var row = filteredData[i];
            if (row.vendedor && row.numFactura) {
                if (!vendedorStats[row.vendedor]) {
                    vendedorStats[row.vendedor] = {
                        ventas: 0,
                        facturas: 0,
                        productos: 0,
                        clientes: new Set()
                    };
                }
                vendedorStats[row.vendedor].ventas += row.total;
                vendedorStats[row.vendedor].facturas++;
                vendedorStats[row.vendedor].productos += row.cantidad;
                vendedorStats[row.vendedor].clientes.add(row.cliente);
            }
        }
        
        var vendedoresArray = [];
        for (var vendedor in vendedorStats) {
            var stats = vendedorStats[vendedor];
            vendedoresArray.push({
                nombre: vendedor,
                ventas: stats.ventas,
                facturas: stats.facturas,
                ticketPromedio: stats.ventas / stats.facturas,
                productosPorFactura: stats.productos / stats.facturas,
                clientesUnicos: stats.clientes.size
            });
        }
        
        vendedoresArray.sort(function(a, b) { return b.ventas - a.ventas; });
        
        analytics.vendedores = vendedoresArray;
    }

    function calculateGeografia() {
        var estadoStats = {};
        
        for (var i = 0; i < filteredData.length; i++) {
            var row = filteredData[i];
            if (row.estado && row.numFactura) {
                if (!estadoStats[row.estado]) {
                    estadoStats[row.estado] = {
                        ventas: 0,
                        facturas: 0,
                        clientes: new Set()
                    };
                }
                estadoStats[row.estado].ventas += row.total;
                estadoStats[row.estado].facturas++;
                estadoStats[row.estado].clientes.add(row.cliente);
            }
        }
        
        var estadosArray = [];
        for (var estado in estadoStats) {
            estadosArray.push({
                nombre: estado,
                ventas: estadoStats[estado].ventas,
                facturas: estadoStats[estado].facturas,
                clientes: estadoStats[estado].clientes.size
            });
        }
        
        estadosArray.sort(function(a, b) { return b.ventas - a.ventas; });
        
        analytics.estados = estadosArray;
    }

    function calculateProyeccion() {
        var now = new Date();
        var mesActual = now.getMonth() + 1;
        var a√±oActual = now.getFullYear();
        var diaActual = now.getDate();
        var diasDelMes = new Date(a√±oActual, mesActual, 0).getDate();
        
        var ventasMes = 0;
        
        for (var i = 0; i < allData.length; i++) {
            if (allData[i].a√±o === a√±oActual && allData[i].mes === mesActual && allData[i].numFactura) {
                ventasMes += allData[i].total;
            }
        }
        
        var promedioDiario = diaActual > 0 ? ventasMes / diaActual : 0;
        var proyeccion = promedioDiario * diasDelMes;
        var metaMensual = analytics.meta2025 / 12;
        var diasRestantes = diasDelMes - diaActual;
        var ventasNecesarias = diasRestantes > 0 ? Math.max(0, (metaMensual - ventasMes) / diasRestantes) : 0;
        
        analytics.proyeccion = {
            ventasMes: ventasMes,
            proyeccion: proyeccion,
            metaMensual: metaMensual,
            diasRestantes: diasRestantes,
            ventasNecesarias: ventasNecesarias,
            promedioDiario: promedioDiario,
            probabilidad: metaMensual > 0 ? (proyeccion / metaMensual) * 100 : 0
        };
    }

    function calculateAlertas() {
        analytics.alertas = {
            buenas: [],
            regulares: [],
            malas: []
        };
        
        if (analytics.avanceVsMeta >= 100) {
            analytics.alertas.buenas.push('‚úÖ Meta anual cumplida (' + analytics.avanceVsMeta.toFixed(1) + '%)');
        } else if (analytics.avanceVsMeta >= 80) {
            analytics.alertas.regulares.push('‚ö†Ô∏è Avance del ' + analytics.avanceVsMeta.toFixed(1) + '% vs meta anual');
        } else {
            analytics.alertas.malas.push('üö® Solo ' + analytics.avanceVsMeta.toFixed(1) + '% de la meta anual cumplida');
        }
        
        if (analytics.crecimientoAnual > 15) {
            analytics.alertas.buenas.push('‚úÖ Crecimiento anual del ' + analytics.crecimientoAnual.toFixed(1) + '%');
        } else if (analytics.crecimientoAnual > 0) {
            analytics.alertas.regulares.push('‚ö†Ô∏è Crecimiento anual del ' + analytics.crecimientoAnual.toFixed(1) + '% (meta: 15%)');
        } else {
            analytics.alertas.malas.push('üö® Ventas cayeron ' + Math.abs(analytics.crecimientoAnual).toFixed(1) + '% vs a√±o anterior');
        }
        
        if (analytics.clientesInactivos.length > 0) {
            analytics.alertas.malas.push('üö® ' + analytics.clientesInactivos.length + ' clientes inactivos (+' + CONFIG.diasClienteInactivo + ' d√≠as)');
        }
        
        var top3Clientes = analytics.clientes.slice(0, 3);
        for (var i = 0; i < top3Clientes.length; i++) {
            analytics.alertas.buenas.push('‚úÖ ' + top3Clientes[i].nombre + ': ' + formatCurrency(top3Clientes[i].total));
        }
    }

    function switchTab(tabName) {
        var tabs = document.querySelectorAll('.tab');
        for (var i = 0; i < tabs.length; i++) {
            tabs[i].classList.remove('active');
        }
        
        var contents = document.querySelectorAll('.tab-content');
        for (var i = 0; i < contents.length; i++) {
            contents[i].classList.remove('active');
        }
        
        event.target.classList.add('active');
        document.getElementById('tab-' + tabName).classList.add('active');
    }

    function renderAllTabs() {
        renderScorecard();
        renderVentas();
        renderClientes();
        renderProductos();
        renderVendedores();
        renderGeografia();
    }

    function formatCurrency(value) {
        return '$' + value.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function renderScorecard() {
        var html = '';
        
        var status = 'good';
        var statusIcon = 'üòä';
        if (analytics.avanceVsMeta < 80) {
            status = 'bad';
            statusIcon = 'üòü';
        } else if (analytics.avanceVsMeta < 100) {
            status = 'warning';
            statusIcon = 'üòê';
        }
        
        html += '<div class="card" style="text-align: center;">';
        html += '<div class="status-indicator ' + status + '">' + statusIcon + '</div>';
        html += '<h2>Estado General del Negocio</h2>';
        html += '<p style="font-size: 1.5em; margin: 10px 0;"><strong>' + analytics.avanceVsMeta.toFixed(1) + '%</strong> de la meta anual cumplida</p>';
        html += '</div>';
        
        if (analytics.alertas.buenas.length > 0) {
            html += '<div class="success-card"><h3>‚úÖ Lo que va bien</h3>';
            for (var i = 0; i < Math.min(3, analytics.alertas.buenas.length); i++) {
                html += '<div>' + analytics.alertas.buenas[i] + '</div>';
            }
            html += '</div>';
        }
        
        if (analytics.alertas.malas.length > 0) {
            html += '<div class="alert-card"><h3>‚ö†Ô∏è Necesita atenci√≥n</h3>';
            for (var i = 0; i < analytics.alertas.malas.length; i++) {
                html += '<div class="alert-item">' + analytics.alertas.malas[i] + '</div>';
            }
            html += '</div>';
        }
        
        if (analytics.alertas.regulares.length > 0) {
            html += '<div class="warning-card"><h3>üìä Observaciones</h3>';
            for (var i = 0; i < analytics.alertas.regulares.length; i++) {
                html += '<div>' + analytics.alertas.regulares[i] + '</div>';
            }
            html += '</div>';
        }
        
        var p = analytics.proyeccion;
        html += '<div class="projection-card">';
        html += '<h2>üéØ Proyecci√≥n del Mes Actual</h2>';
        html += '<div class="projection-grid">';
        html += '<div class="projection-item"><h4>Meta Mensual</h4><div class="value">' + formatCurrency(p.metaMensual) + '</div></div>';
        html += '<div class="projection-item"><h4>Ventas a la Fecha</h4><div class="value">' + formatCurrency(p.ventasMes) + '</div></div>';
        html += '<div class="projection-item"><h4>Proyecci√≥n</h4><div class="value">' + formatCurrency(p.proyeccion) + '</div><div>' + p.probabilidad.toFixed(0) + '% probabilidad</div></div>';
        html += '<div class="projection-item"><h4>Promedio Diario</h4><div class="value">' + formatCurrency(p.promedioDiario) + '</div><div>' + p.diasRestantes + ' d√≠as restantes</div></div>';
        html += '</div></div>';
        
        html += '<div class="kpis">';
        html += '<div class="kpi-card"><h3>Ventas Totales</h3><div class="value">' + formatCurrency(analytics.totalVentas) + '</div></div>';
        html += '<div class="kpi-card"><h3>Facturas</h3><div class="value">' + analytics.numFacturas + '</div></div>';
        html += '<div class="kpi-card"><h3>Ticket Promedio</h3><div class="value">' + formatCurrency(analytics.ticketPromedio) + '</div></div>';
        html += '<div class="kpi-card"><h3>Total Clientes</h3><div class="value">' + analytics.totalClientes + '</div></div>';
        html += '</div>';
        
        html += '<div class="kpis">';
        html += '<div class="kpi-card"><h3>Ventas 2024</h3><div class="value">' + formatCurrency(analytics.ventas2024) + '</div></div>';
        html += '<div class="kpi-card"><h3>Meta 2025 (+15%)</h3><div class="value">' + formatCurrency(analytics.meta2025) + '</div></div>';
        html += '<div class="kpi-card"><h3>Ventas 2025</h3><div class="value">' + formatCurrency(analytics.ventas2025) + '</div></div>';
        html += '<div class="kpi-card"><h3>Crecimiento Anual</h3><div class="value ' + (analytics.crecimientoAnual >= 0 ? 'trend up' : 'trend down') + '">' + analytics.crecimientoAnual.toFixed(1) + '%</div></div>';
        html += '</div>';
        
        html += '<div class="charts">';
        html += '<div class="chart-card"><h3>Top 5 Clientes</h3><canvas id="chartTopClientes"></canvas></div>';
        html += '<div class="chart-card"><h3>Top 5 Productos</h3><canvas id="chartTopProductos"></canvas></div>';
        html += '</div>';
        
        html += '<div class="charts">';
        html += '<div class="chart-card"><h3>Concentraci√≥n de Clientes (Regla 80/20)</h3><canvas id="chartConcentracion"></canvas></div>';
        html += '<div class="chart-card"><h3>Ventas por D√≠a de la Semana</h3><canvas id="chartDiasSemana"></canvas></div>';
        html += '</div>';
        
        document.getElementById('tab-scorecard').innerHTML = html;
        
        setTimeout(function() {
            createTopClientesChart();
            createTopProductosChart();
            createConcentracionChart();
            createDiasSemanChart();
        }, 100);
    }

    function renderVentas() {
        var html = '<div class="kpis">';
        html += '<div class="kpi-card"><h3>Crecimiento Anual</h3><div class="value ' + (analytics.crecimientoAnual >= 0 ? 'trend up' : 'trend down') + '">' + analytics.crecimientoAnual.toFixed(1) + '%</div></div>';
        html += '<div class="kpi-card"><h3>Total Descuentos</h3><div class="value">' + formatCurrency(analytics.totalDescuentos) + '</div><div class="trend">(' + analytics.pctDescuento.toFixed(1) + '% de ventas)</div></div>';
        html += '<div class="kpi-card"><h3>Clientes Nuevos</h3><div class="value">' + analytics.clientesNuevos.length + '</div></div>';
        html += '</div>';
        
        html += '<div class="charts">';
        html += '<div class="chart-card"><h3>Evoluci√≥n 2024 vs 2025</h3><canvas id="chartEvolucion"></canvas></div>';
        html += '<div class="chart-card"><h3>Tendencia Mensual 2025</h3><canvas id="chartTendencia2025"></canvas></div>';
        html += '</div>';
        
        document.getElementById('tab-ventas').innerHTML = html;
        
        setTimeout(function() {
            createEvolucionChart();
            createTendencia2025Chart();
        }, 100);
    }

    function renderClientes() {
        var html = '<div class="kpis">';
        
        var segmentos = {VIP: 0, Leal: 0, Ocasional: 0, Riesgo: 0};
        for (var i = 0; i < analytics.clientes.length; i++) {
            segmentos[analytics.clientes[i].segmento]++;
        }
        
        html += '<div class="kpi-card"><h3>Clientes VIP</h3><div class="value">' + segmentos.VIP + '</div></div>';
        html += '<div class="kpi-card"><h3>Clientes Leales</h3><div class="value">' + segmentos.Leal + '</div></div>';
        html += '<div class="kpi-card"><h3>Ocasionales</h3><div class="value">' + segmentos.Ocasional + '</div></div>';
        html += '<div class="kpi-card"><h3>En Riesgo</h3><div class="value">' + segmentos.Riesgo + '</div></div>';
        html += '</div>';
        
        html += '<div class="card"><h3>Top 20 Clientes</h3><table>';
        html += '<thead><tr><th>Cliente</th><th>Segmento</th><th>Ventas</th><th>Facturas</th><th>Ticket Prom.</th><th>% Acumulado</th><th>√öltima Compra</th></tr></thead>';
        html += '<tbody>';
        
        for (var i = 0; i < Math.min(20, analytics.clientes.length); i++) {
            var c = analytics.clientes[i];
            html += '<tr>';
            html += '<td>' + c.nombre + '</td>';
            html += '<td><span class="badge ' + c.segmento + '">' + c.segmento + '</span></td>';
            html += '<td>' + formatCurrency(c.total) + '</td>';
            html += '<td>' + c.facturas + '</td>';
            html += '<td>' + formatCurrency(c.ticketPromedio) + '</td>';
            html += '<td>' + c.pctAcumulado.toFixed(1) + '%</td>';
            html += '<td>' + c.ultimaCompra.toLocaleDateString('es-MX') + '</td>';
            html += '</tr>';
        }
        
        html += '</tbody></table></div>';
        
        document.getElementById('tab-clientes').innerHTML = html;
    }

    function renderProductos() {
        var categorias = {A: 0, B: 0, C: 0};
        for (var i = 0; i < analytics.productos.length; i++) {
            categorias[analytics.productos[i].categoria]++;
        }
        
        var html = '<div class="kpis">';
        html += '<div class="kpi-card"><h3>Productos A (Top 80%)</h3><div class="value">' + categorias.A + '</div></div>';
        html += '<div class="kpi-card"><h3>Productos B (80-95%)</h3><div class="value">' + categorias.B + '</div></div>';
        html += '<div class="kpi-card"><h3>Productos C (95-100%)</h3><div class="value">' + categorias.C + '</div></div>';
        html += '<div class="kpi-card"><h3>Total Productos</h3><div class="value">' + analytics.productos.length + '</div></div>';
        html += '</div>';
        
        html += '<div class="card"><h3>Top 30 Productos</h3><table>';
        html += '<thead><tr><th>Producto</th><th>Categor√≠a ABC</th><th>Cantidad</th><th>Valor</th><th>Facturas</th><th>D√≠as sin Venta</th></tr></thead>';
        html += '<tbody>';
        
        for (var i = 0; i < Math.min(30, analytics.productos.length); i++) {
            var p = analytics.productos[i];
            html += '<tr>';
            html += '<td>' + p.nombre + '</td>';
            html += '<td><span class="badge ' + p.categoria + '">' + p.categoria + '</span></td>';
            html += '<td>' + p.cantidad + '</td>';
            html += '<td>' + formatCurrency(p.valor) + '</td>';
            html += '<td>' + p.facturas + '</td>';
            html += '<td>' + p.diasSinVenta + '</td>';
            html += '</tr>';
        }
        
        html += '</tbody></table></div>';
        
        document.getElementById('tab-productos').innerHTML = html;
    }

    function renderVendedores() {
        var html = '<div class="kpis">';
        html += '<div class="kpi-card"><h3>Total Vendedores</h3><div class="value">' + analytics.vendedores.length + '</div></div>';
        
        if (analytics.vendedores.length > 0) {
            var topVendedor = analytics.vendedores[0];
            html += '<div class="kpi-card"><h3>Top Vendedor</h3><div class="value" style="font-size: 1.5em;">' + topVendedor.nombre + '</div><div class="trend">' + formatCurrency(topVendedor.ventas) + '</div></div>';
        }
        html += '</div>';
        
        html += '<div class="card"><h3>Desempe√±o de Vendedores</h3><table>';
        html += '<thead><tr><th>Vendedor</th><th>Ventas</th><th>Facturas</th><th>Ticket Promedio</th><th>Productos/Factura</th><th>Clientes √önicos</th></tr></thead>';
        html += '<tbody>';
        
        for (var i = 0; i < analytics.vendedores.length; i++) {
            var v = analytics.vendedores[i];
            html += '<tr>';
            html += '<td>' + v.nombre + '</td>';
            html += '<td>' + formatCurrency(v.ventas) + '</td>';
            html += '<td>' + v.facturas + '</td>';
            html += '<td>' + formatCurrency(v.ticketPromedio) + '</td>';
            html += '<td>' + v.productosPorFactura.toFixed(1) + '</td>';
            html += '<td>' + v.clientesUnicos + '</td>';
            html += '</tr>';
        }
        
        html += '</tbody></table></div>';
        
        html += '<div class="chart-card"><h3>Comparativo de Vendedores</h3><canvas id="chartVendedores"></canvas></div>';
        
        document.getElementById('tab-vendedores').innerHTML = html;
        
        setTimeout(function() {
            createVendedoresChart();
        }, 100);
    }

    function renderGeografia() {
        var html = '<div class="kpis">';
        html += '<div class="kpi-card"><h3>Total Estados</h3><div class="value">' + analytics.estados.length + '</div></div>';
        
        if (analytics.estados.length > 0) {
            var topEstado = analytics.estados[0];
            html += '<div class="kpi-card"><h3>Top Estado</h3><div class="value" style="font-size: 1.5em;">' + topEstado.nombre + '</div><div class="trend">' + formatCurrency(topEstado.ventas) + '</div></div>';
        }
        html += '</div>';
        
        html += '<div class="card"><h3>Ventas por Estado</h3><table>';
        html += '<thead><tr><th>Estado</th><th>Ventas</th><th>Facturas</th><th>Clientes</th></tr></thead>';
        html += '<tbody>';
        
        for (var i = 0; i < analytics.estados.length; i++) {
            var e = analytics.estados[i];
            html += '<tr>';
            html += '<td>' + e.nombre + '</td>';
            html += '<td>' + formatCurrency(e.ventas) + '</td>';
            html += '<td>' + e.facturas + '</td>';
            html += '<td>' + e.clientes + '</td>';
            html += '</tr>';
        }
        
        html += '</tbody></table></div>';
        
        html += '<div class="chart-card"><h3>Top 10 Estados por Ventas</h3><canvas id="chartEstados"></canvas></div>';
        
        document.getElementById('tab-geografia').innerHTML = html;
        
        setTimeout(function() {
            createEstadosChart();
        }, 100);
    }

    function createTopClientesChart() {
        var ctx = document.getElementById('chartTopClientes');
        if (!ctx) return;
        
        var top5 = analytics.clientes.slice(0, 5);
        var labels = [];
        var data = [];
        
        for (var i = 0; i < top5.length; i++) {
            labels.push(top5[i].nombre);
            data.push(top5[i].total);
        }
        
        if (charts.topClientes) charts.topClientes.destroy();
        
        charts.topClientes = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ventas',
                    data: data,
                    backgroundColor: '#5e72e4'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }

    function createTopProductosChart() {
        var ctx = document.getElementById('chartTopProductos');
        if (!ctx) return;
        
        var top5 = analytics.productos.slice(0, 5);
        var labels = [];
        var data = [];
        
        for (var i = 0; i < top5.length; i++) {
            labels.push(top5[i].nombre.substring(0, 30));
            data.push(top5[i].valor);
        }
        
        if (charts.topProductos) charts.topProductos.destroy();
        
        charts.topProductos = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ventas',
                    data: data,
                    backgroundColor: '#10b981'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }

    function createConcentracionChart() {
        var ctx = document.getElementById('chartConcentracion');
        if (!ctx) return;
        
        var top20 = analytics.clientes.slice(0, Math.ceil(analytics.clientes.length * 0.2));
        var labels = [];
        var pcts = [];
        
        for (var i = 0; i < Math.min(10, top20.length); i++) {
            labels.push(top20[i].nombre);
            pcts.push(top20[i].pctAcumulado);
        }
        
        if (charts.concentracion) charts.concentracion.destroy();
        
        charts.concentracion = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '% Acumulado',
                    data: pcts,
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    function createDiasSemanChart() {
        var ctx = document.getElementById('chartDiasSemana');
        if (!ctx) return;
        
        var dias = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
        var data = [];
        
        for (var i = 0; i < 7; i++) {
            data.push(analytics.ventasPorDia[i] || 0);
        }
        
        if (charts.diasSemana) charts.diasSemana.destroy();
        
        charts.diasSemana = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dias,
                datasets: [{
                    label: 'Ventas',
                    data: data,
                    backgroundColor: '#8b5cf6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }

    function createEvolucionChart() {
        var ctx = document.getElementById('chartEvolucion');
        if (!ctx) return;
        
        var meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        var ventas2024 = [0,0,0,0,0,0,0,0,0,0,0,0];
        var ventas2025 = [0,0,0,0,0,0,0,0,0,0,0,0];
        
        for (var i = 0; i < allData.length; i++) {
            if (allData[i].numFactura) {
                if (allData[i].a√±o === 2024) {
                    ventas2024[allData[i].mes - 1] += allData[i].total;
                } else if (allData[i].a√±o === 2025) {
                    ventas2025[allData[i].mes - 1] += allData[i].total;
                }
            }
        }
        
        if (charts.evolucion) charts.evolucion.destroy();
        
        charts.evolucion = new Chart(ctx, {
            type: 'line',
            data: {
                labels: meses,
                datasets: [
                    {
                        label: '2024',
                        data: ventas2024,
                        borderColor: '#94a3b8',
                        tension: 0.4
                    },
                    {
                        label: '2025',
                        data: ventas2025,
                        borderColor: '#5e72e4',
                        tension: 0.4,
                        borderWidth: 3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }

    function createTendencia2025Chart() {
        var ctx = document.getElementById('chartTendencia2025');
        if (!ctx) return;
        
        var meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        var ventas = [0,0,0,0,0,0,0,0,0,0,0,0];
        
        for (var i = 0; i < allData.length; i++) {
            if (allData[i].numFactura && allData[i].a√±o === 2025) {
                ventas[allData[i].mes - 1] += allData[i].total;
            }
        }
        
        if (charts.tendencia2025) charts.tendencia2025.destroy();
        
        charts.tendencia2025 = new Chart(ctx, {
            type: 'line',
            data: {
                labels: meses,
                datasets: [{
                    label: '2025',
                    data: ventas,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }

    function createVendedoresChart() {
        var ctx = document.getElementById('chartVendedores');
        if (!ctx) return;
        
        var labels = [];
        var data = [];
        
        for (var i = 0; i < Math.min(10, analytics.vendedores.length); i++) {
            labels.push(analytics.vendedores[i].nombre);
            data.push(analytics.vendedores[i].ventas);
        }
        
        if (charts.vendedores) charts.vendedores.destroy();
        
        charts.vendedores = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ventas',
                    data: data,
                    backgroundColor: '#ec4899'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }

    function createEstadosChart() {
        var ctx = document.getElementById('chartEstados');
        if (!ctx) return;
        
        var labels = [];
        var data = [];
        
        for (var i = 0; i < Math.min(10, analytics.estados.length); i++) {
            labels.push(analytics.estados[i].nombre);
            data.push(analytics.estados[i].ventas);
        }
        
        if (charts.estados) charts.estados.destroy();
        
        charts.estados = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ventas',
                    data: data,
                    backgroundColor: '#06b6d4'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }

    msalInstance.handleRedirectPromise().then(function(response) {
        if (response) {
            document.getElementById('loginCard').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('userInfo').textContent = 'Usuario: ' + response.account.name;
            loadData();
        }
    });
    </script>
</body>
</html>
